<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
      <title>CoCo ShadowLedger v8.10 (Current)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#14B8A6">
    <meta name="description" content="Shadow Payroll Tracker for AMR Paramedics & EMTs - Verify your paycheck accuracy">
    
    <!-- Favicons & Icons -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="logo-icon-color.svg">
    <link rel="manifest" href="manifest.json">
    
    <!-- Load Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React & ReactDOM (UMD - Works without server) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Load Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Brand Colors - CoCo ShadowLedger */
        :root {
            --color-primary: #14B8A6;
            --color-primary-dark: #0D9488;
            --color-primary-darker: #0F766E;
            --color-secondary: #F97316;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            --color-dark: #0F172A;
        }
        
        body { background-color: #f8fafc; overscroll-behavior-y: none; font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .ai-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        /* Hide number input spinner arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* PDF/Print Styles */
        @media print {
            @page { size: letter; margin: 0.5in; }
            
            body { background: white !important; }
            
            /* Hide interactive elements */
            .no-print, button, input, textarea, .ai-glow { display: none !important; }
            
            /* Header for PDF */
            .print-header { 
                display: block !important;
                border-bottom: 3px solid #0f172a;
                padding-bottom: 1rem;
                margin-bottom: 2rem;
            }
            
            /* Ensure proper page breaks */
            .page-break-before { page-break-before: always; }
            .page-break-after { page-break-after: always; }
            .no-page-break { page-break-inside: avoid; }
            
            /* Expand all rows */
            .expandable-row { display: block !important; max-height: none !important; }
            
            /* Clean table styling */
            table, .print-table { 
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 1rem;
            }
            
            .print-table-row {
                border-bottom: 1px solid #e5e7eb;
                padding: 0.5rem 0;
            }
            
            /* Ensure text is black for clarity */
            * { color: black !important; }
            .text-emerald-600, .text-teal-600, .text-red-600 { 
                font-weight: bold !important;
            }
        }
        
        /* Hidden by default, shown in print */
        .print-only { display: none; }
        @media print {
            .print-only { display: block !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;
        const { createRoot } = ReactDOM;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”‘ CONFIGURATION & CONSTANTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âš ï¸ SECURITY WARNING: Any key placed here is visible to users via "View Source".
        // For public apps, use a backend proxy. For internal pilots, this is acceptable.
        // ğŸ”‘ Get a fresh key at: https://aistudio.google.com/app/apikey
        const GLOBAL_API_KEY = "AIzaSyDeQpobrFd8aB5jc79IagD0i1pmNqoGxM4"; 

        // Validation tolerances
        const PAY_TOLERANCE = 10.0;
        const HOURS_TOLERANCE = 0.5;
        
        // Default settings
        const DEFAULT_SETTINGS = {
            baseRate: 40,
            maxStack: 3.0,
            otThreshold: 40,
            dtThreshold: 12,
            workWeekStartDay: 0,
            mealBonusHours: 1,
            holidayRate: 1.5,
            nightDiffRate: 3.0,
            payPeriodAnchor: new Date().toISOString().split('T')[0]
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¤– AI INTEGRATION - GEMINI API
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Calls Google Gemini API for AI-powered payroll analysis
         * @param {string} prompt - The analysis prompt to send
         * @param {string} userKey - Optional user-provided API key
         * @returns {Promise<string>} AI-generated analysis text
         * @throws {Error} If API key is missing or API call fails
         */
        async function callGemini(prompt, userKey) {
            // Prioritize Global Key (Admin provided), then User Key (Local storage)
            const keyToUse = GLOBAL_API_KEY || userKey;
            
            if (!keyToUse) throw new Error("Missing API Key");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            let attempt = 0;
            const delays = [1000, 2000, 4000]; // Backoff strategy

            while (attempt <= 3) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errData = await response.json().catch(()=>({}));
                        if (response.status === 429) throw new Error("Rate limit exceeded. Wait 1 minute and try again.");
                        if (response.status === 400) throw new Error("Invalid API Key. Check that you copied it correctly from Google AI Studio.");
                        if (response.status === 403) throw new Error("API Key lacks permissions. Make sure you created the key at aistudio.google.com/app/apikey");
                        throw new Error(`API Error ${response.status}: ${errData.error?.message || 'Unknown error'}`);
                    }

                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis generated.";
                } catch (error) {
                    if (attempt === 3 || error.message.includes("Invalid API Key") || error.message.includes("Missing API Key")) throw error;
                    await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                    attempt++;
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ›¡ï¸ ERROR HANDLING - ERROR BOUNDARY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * React Error Boundary - catches and handles component crashes
         * Provides recovery option by clearing localStorage
         */
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("App Crash:", error, errorInfo);
            }
            handleReset = () => {
                localStorage.clear();
                window.location.reload();
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6">
                            <div className="bg-white p-8 rounded-xl shadow-lg border border-red-100 max-w-md w-full">
                                <h2 className="text-2xl font-bold text-slate-800 mb-2">Recovery Mode</h2>
                                <p className="text-slate-600 mb-4 text-sm">The app encountered a critical error.</p>
                                <div className="bg-slate-100 p-3 rounded text-xs font-mono text-red-600 mb-6 break-all">
                                    {this.state.error && this.state.error.toString()}
                                </div>
                                <button onClick={this.handleReset} className="w-full py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-colors">Reset App Data</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¨ UI LIBRARY - SVG ICONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /** Collection of inline SVG icons used throughout the app */
        const Icons = {
            Plus: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Settings: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            ChevronDown: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m6 9 6 6 6-6"/></svg>,
            ChevronUp: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m18 15-6-6-6 6"/></svg>,
            FileText: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            X: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Search: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            ArrowRight: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            AlertTriangle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            CheckCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Clipboard: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
            LayoutList: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/><path d="M14 4h7"/><path d="M14 9h7"/><path d="M14 15h7"/><path d="M14 20h7"/></svg>,
            CalendarRange: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M17 14h-6"/><path d="M13 18H7"/></svg>,
            Grid: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="3" x2="21" y1="15" y2="15"/><line x1="9" x2="9" y1="3" y2="21"/><line x1="15" x2="15" y1="3" y2="21"/></svg>,
            ExternalLink: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>,
            ShieldAlert: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Copy: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Book: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Info: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>,
            Lightbulb: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>,
            Lock: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            PlayCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>,
            Sparkles: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            DollarSign: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            TrendingUp: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Database: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/></svg>,
            HelpCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Edit: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Zap: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            AlertCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Clock: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ CORE UTILITIES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /** Core utility functions used throughout the app */
        const Utils = {
            /** Generates a random unique ID for shifts/line items */
            generateId: () => Math.random().toString(36).substr(2, 9),
            
            /** Formats a number as USD currency */
            formatMoney: (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val),
            
            /** Converts year, month, day to ISO date string (YYYY-MM-DD) */
            toISODateString: (y, m, d) => `${y}-${(m + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`,
        };
        
        // Backwards compatibility aliases
        const generateId = Utils.generateId;
        const formatMoney = Utils.formatMoney;
        const toISODateString = Utils.toISODateString;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“Š DATA PARSERS - TIMECARD & PAYROLL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Parses raw Kronos timecard text into structured shift data
         * @param {string} rawText - Copy-pasted text from Kronos/UKG
         * @returns {Object} { success: boolean, shifts: Array, minDate: string }
         */
        const parseTimecardHelper = (rawText) => {
            const newShifts = [];
            const currentYear = new Date().getFullYear();
            const kronosRegex = /(Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)[,.:]?\s+([A-Z][a-z]+)\s+(\d{1,2})/gi;
            const genericRegex = /(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?[\s,]+(\d{1,2})|(\d{1,2})\/(\d{1,2})/gi;
            
            let match, headers = [], foundKronos = false;
            while ((match = kronosRegex.exec(rawText)) !== null) {
                foundKronos = true;
                headers.push({ index: match.index, month: match[2], day: parseInt(match[3]), weekday: match[1] });
            }
            if (!foundKronos) {
                while ((match = genericRegex.exec(rawText)) !== null) {
                    let mStr, d;
                    if (match[1]) { mStr = match[0].substr(0,3); d = parseInt(match[1]); }
                    else { const date = new Date(currentYear, parseInt(match[2])-1, parseInt(match[3])); mStr = date.toLocaleString('default', { month: 'short' }); d = parseInt(match[3]); }
                    headers.push({ index: match.index, month: mStr, day: d });
                }
            }
            if (headers.length === 0) return { success: false };

            headers.sort((a,b) => a.index - b.index);
            let minDateStr = null;

            headers.forEach((header, i) => {
                const start = header.index;
                const end = (i + 1 < headers.length) ? headers[i+1].index : rawText.length;
                const chunk = rawText.substring(start, end);
                let resolvedYear = currentYear;

                if (header.weekday) {
                    const testDate = new Date(`${header.month} ${header.day} ${currentYear}`);
                    const testDay = testDate.toLocaleDateString('en-US', {weekday:'long'});
                    if(testDay !== header.weekday) {
                        const prevDate = new Date(`${header.month} ${header.day} ${currentYear - 1}`);
                        if(prevDate.toLocaleDateString('en-US', {weekday:'long'}) === header.weekday) resolvedYear = currentYear - 1;
                        else resolvedYear = currentYear + 1;
                    }
                }
                const monthIdx = new Date(`${header.month} 1 ${resolvedYear}`).getMonth();
                if (isNaN(monthIdx)) return;

                const isoDate = toISODateString(resolvedYear, monthIdx, header.day);
                if (!minDateStr || isoDate < minDateStr) minDateStr = isoDate;

                const timeRegex = /((?:1[0-2]|0?[1-9])(?::\d{2})?\s*[ap]m)|((?:[01]?\d|2[0-3]):\d{2})/gi;
                const times = [];
                let tMatch;
                while ((tMatch = timeRegex.exec(chunk)) !== null) times.push(tMatch[0]);

                const normTime = (t) => {
                    let c = t.toLowerCase().replace(/\s/g, '').replace(/([ap]m)/, ' $1');
                    if(c.indexOf(':') === -1 && (c.includes('am') || c.includes('pm'))) c = c.replace(/(\d+)\s*([ap]m)/, '$1:00 $2');
                    const d = new Date(`1/1/2000 ${c}`);
                    return isNaN(d) ? null : d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                };

                if (times.length >= 2) {
                    for(let j=0; j<times.length; j+=2) {
                        if(j+1 < times.length) {
                            const sT = normTime(times[j]), eT = normTime(times[j+1]);
                            if(sT && eT) {
                                const hasHoldoverText = /holdover/i.test(chunk);
                                newShifts.push({
                                    id: generateId(), date: isoDate, startTime: sT, endTime: eT,
                                    isHoliday: false, claimFreeHour: /no break/i.test(chunk),
                                    isHoldover: hasHoldoverText, isMando: false, isPaidLeave: false, paidLeaveHours: 12
                                });
                            }
                        }
                    }
                } else if (/sick|vacation|pto|absence|holiday/i.test(chunk)) {
                    newShifts.push({
                        id: generateId(), date: isoDate, startTime: '17:00', endTime: '05:00',
                        isHoliday: false, claimFreeHour: false, isHoldover: false, isMando: false, isPaidLeave: true, paidLeaveHours: 12
                    });
                }
            });
            return { success: true, shifts: newShifts, minDate: minDateStr };
        };

        /**
         * Parses raw Payroll Activity Report (PAR) text from ServiceNow
         * @param {string} rawText - Copy-pasted text from PAR
         * @param {Object} currentReport - Existing report data to merge with
         * @returns {Object} { success: boolean, data: Object, count: number }
         */
        const parsePayrollReportHelper = (rawText, currentReport) => {
            const lines = rawText.split('\n').map(l => l.trim()).filter(l => l);
            const newReportData = { ...currentReport };
            let currentDate = null, importCount = 0;
            const foundDates = [];
            const dateLineRegex = /^(\d{2}\/\d{2}\/\d{4})$/; 
            const datesClearedInThisImport = new Set();
            
            // Known pay codes to look for
            const knownPayCodes = [
                'Regular', 'Regular Unsch', 'NF Holdover', 'Overtime Unsch', 
                'NF No Break', 'Overtime', 'Train Reg', 'Train OT', 
                'Imputed Income DP Medical', 'Meeting', 'Holiday', 'Sick',
                'PTO', 'Vacation', 'Bereavement', 'Night Differential',
                'Mando', 'Holdover', 'Missed Meal', 'Standby'
            ];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Check for date line
                if (dateLineRegex.test(line) && !line.includes('-')) {
                    const [m, d, y] = line.split('/');
                    currentDate = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                    if (!datesClearedInThisImport.has(currentDate)) {
                        newReportData[currentDate] = { entries: [], totalPay: 0, totalHours: 0 };
                        datesClearedInThisImport.add(currentDate);
                    }
                    foundDates.push(currentDate);
                    continue;
                }
                
                // Method 1: Look for "FLSA Hours" or "Non-FLSA Hours" triggers
                if ((line === 'FLSA Hours' || line === 'Non-FLSA Hours') && currentDate) {
                    const code = lines[i-1]; 
                    const numRegex = /^(\d{1,5}(\.\d{1,4})?)$/;
                    const buffer = [];
                    for (let j = 1; j <= 6; j++) {
                        if (i+j < lines.length && numRegex.test(lines[i+j].replace(',',''))) buffer.push(parseFloat(lines[i+j].replace(',','')));
                    }
                    if (buffer.length >= 3) {
                        const [hours, rate, amount] = buffer;
                        newReportData[currentDate].entries.push({ code, hours, rate, amount });
                        newReportData[currentDate].totalPay += amount;
                        if(!code.toLowerCase().includes('no break') && !code.toLowerCase().includes('imputed')) newReportData[currentDate].totalHours += hours;
                        importCount++;
                    }
                    continue;
                }
                
                // Method 2: Look for known pay codes followed by numbers
                // Handle formats like "Regular" or "Medical.. : Regular"
                if (currentDate) {
                    let matchedCode = null;
                    
                    // Check if line matches a known pay code exactly
                    if (knownPayCodes.includes(line)) {
                        matchedCode = line;
                    }
                    // Check if line contains a pay code after a colon (e.g., "Medical.. : Regular")
                    else if (line.includes(':')) {
                        const afterColon = line.split(':').pop().trim();
                        if (knownPayCodes.includes(afterColon)) {
                            matchedCode = afterColon;
                        }
                    }
                    // Check if line ends with a known pay code
                    else {
                        for (const code of knownPayCodes) {
                            if (line.endsWith(code)) {
                                matchedCode = code;
                                break;
                            }
                        }
                    }
                    
                    if (matchedCode) {
                        // Look ahead for 3 numbers: hours, rate, amount
                        const numRegex = /^(\d{1,5}(\.\d{1,4})?)$/;
                        const buffer = [];
                        for (let j = 1; j <= 8; j++) {
                            if (i+j < lines.length) {
                                const testLine = lines[i+j].replace(',','');
                                if (numRegex.test(testLine)) {
                                    buffer.push(parseFloat(testLine));
                                    if (buffer.length === 3) break;
                                }
                            }
                        }
                        if (buffer.length >= 3) {
                            const [hours, rate, amount] = buffer;
                            // Only add if not already added (avoid duplicates)
                            const alreadyExists = newReportData[currentDate].entries.some(
                                e => e.code === matchedCode && e.hours === hours && e.amount === amount
                            );
                            if (!alreadyExists) {
                                newReportData[currentDate].entries.push({ code: matchedCode, hours, rate, amount });
                                newReportData[currentDate].totalPay += amount;
                                if(!matchedCode.toLowerCase().includes('no break') && !matchedCode.toLowerCase().includes('imputed')) {
                                    newReportData[currentDate].totalHours += hours;
                                }
                                importCount++;
                            }
                        }
                    }
                }
            }
            return { success: importCount > 0, data: newReportData, count: importCount, dates: foundDates };
        };

        // --- COMPONENTS ---

        const AiAssistant = ({ shifts, report, calculated, onClose }) => {
            const [analysis, setAnalysis] = useState("");
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [userKey, setUserKey] = useState(localStorage.getItem('gemini_api_key') || "");
            const [needsKey, setNeedsKey] = useState(!GLOBAL_API_KEY && !localStorage.getItem('gemini_api_key'));

            const runAnalysis = async (keyToUse) => {
                setLoading(true);
                setError(null);
                try {
                    const reportTotal = Object.values(report).reduce((acc, day) => acc + day.totalPay, 0);
                    const prompt = `
                        You're an EMS payroll expert. Analyze this paycheck quickly.
                        
                        **Numbers:**
                        - Expected: ${formatMoney(calculated.grandTotalPay)}
                        - Actually Paid: ${formatMoney(reportTotal)}
                        - Difference: ${formatMoney(reportTotal - calculated.grandTotalPay)}
                        
                        **Format (use exactly this):**
                        
                        ## ğŸ“Š Verdict: [MATCH / OVERPAID / UNDERPAID]
                        
                        [2 sentences max explaining the overall situation]
                        
                        **Issues:**
                        - **[Date]**: [Pay Code] off by [amount/hours] 
                        - **[Date]**: [Pay Code] off by [amount/hours]
                        
                        [If perfect match, just say "All codes match. No issues."]
                        
                        **Root Cause:** [One sentence why]
                        
                        Keep it brief. Only list significant issues (>$5 or >0.5h difference).
                        
                        **Data:**
                        ${JSON.stringify({
                            shifts: shifts.map(s => ({date: s.date, type: s.isMando ? 'Mando' : 'Regular', hours: s.endTime})), 
                            report: report
                        })}
                    `;
                    const result = await callGemini(prompt, keyToUse);
                    setAnalysis(result);
                } catch (err) {
                    if (err.message.includes("Invalid API Key") || err.message.includes("Missing API Key")) {
                        setNeedsKey(true);
                        setError("API Key Required or Invalid");
                    } else {
                        setError(err.message || "Could not generate analysis. Please try again.");
                    }
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (!needsKey) {
                    runAnalysis(userKey);
                }
            }, []);

            const handleSaveKey = () => {
                if (!userKey || userKey.trim().length < 10) {
                    setError("Please enter a valid API key (starts with AIza...)");
                    return;
                }
                localStorage.setItem('gemini_api_key', userKey.trim());
                setNeedsKey(false);
                setError(null);
                runAnalysis(userKey.trim());
            };

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 print:relative print:bg-transparent print:inset-auto print:block print:p-0 print:mt-8 page-break-before">
                    <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[80vh] flex flex-col overflow-hidden print:max-h-none print:shadow-none print:max-w-full">
                        <div className="bg-teal-500 p-4 flex justify-between items-center text-white print:bg-white print:text-slate-900 print:border-b-2 print:border-teal-500">
                            <h3 className="font-bold flex items-center gap-2"><Icons.Sparkles className="w-5 h-5"/> AI Pay Analysis</h3>
                            <button onClick={onClose} className="hover:bg-teal-600 p-1 rounded no-print"><Icons.X className="w-5 h-5"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1 print:overflow-visible">
                            {needsKey ? (
                                <div className="space-y-4">
                                    <div className="bg-amber-50 p-5 rounded-lg border border-amber-300">
                                        <div className="flex items-start gap-3 mb-3">
                                            <Icons.Lock className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5"/>
                                            <div>
                                                <p className="text-sm text-amber-900 font-bold mb-1">Google Gemini API Key Required</p>
                                                <p className="text-xs text-amber-800 mb-3">This AI feature needs a free Google API key. Your key stays on your device.</p>
                                                <a 
                                                    href="https://aistudio.google.com/app/apikey" 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="inline-flex items-center gap-1.5 text-xs text-teal-600 font-bold hover:text-teal-700 underline mb-4"
                                                >
                                                    â†’ Get free API key here
                                                </a>
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <input 
                                                type="text" 
                                                placeholder="Paste your API key (starts with AIza...)" 
                                                className="w-full border border-amber-300 p-3 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                                value={userKey}
                                                onChange={(e) => { setUserKey(e.target.value); setError(null); }}
                                                onKeyPress={(e) => { if (e.key === 'Enter') handleSaveKey(); }}
                                            />
                                            <button 
                                                onClick={handleSaveKey} 
                                                disabled={!userKey || userKey.length < 10}
                                                className="w-full bg-teal-500 text-white px-4 py-3 rounded-lg text-sm font-bold hover:bg-teal-600 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors shadow-sm"
                                            >
                                                Save & Analyze
                                            </button>
                                        </div>
                                    </div>
                                    {error && (
                                        <div className="bg-red-50 border border-red-200 rounded-lg p-3 flex items-start gap-2">
                                            <Icons.AlertTriangle className="w-4 h-4 text-red-600 flex-shrink-0 mt-0.5"/>
                                            <p className="text-red-700 text-xs font-medium">{error}</p>
                                        </div>
                                    )}
                                </div>
                            ) : loading ? (
                                <div className="text-center py-12">
                                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-500 mx-auto mb-4"></div>
                                    <p className="text-slate-600 font-medium mb-1">Analyzing your paycheck...</p>
                                    <p className="text-slate-400 text-xs">This usually takes 3-5 seconds</p>
                                </div>
                            ) : error ? (
                                <div className="text-center py-4">
                                    <p className="text-red-500 font-bold mb-2">{error}</p>
                                    <button onClick={() => runAnalysis(userKey)} className="text-teal-600 underline text-sm hover:text-teal-700">Try Again</button>
                                </div>
                            ) : (
                                <div className="bg-gradient-to-br from-indigo-50 to-white rounded-lg p-6 border border-indigo-100">
                                    <div className="prose prose-sm max-w-none text-slate-700">
                                        <style>{`
                                            .prose h2 { 
                                                color: #1e293b; 
                                                font-size: 1.2rem; 
                                                font-weight: 700; 
                                                margin-top: 0; 
                                                margin-bottom: 1rem;
                                                padding-bottom: 0.5rem;
                                                border-bottom: 2px solid #e0e7ff;
                                            }
                                            .prose p { 
                                                margin-bottom: 0.875rem; 
                                                line-height: 1.7; 
                                            }
                                            .prose strong { 
                                                color: #1e40af; 
                                                font-weight: 600; 
                                            }
                                            .prose ul { 
                                                margin-top: 0.75rem; 
                                                margin-bottom: 1rem; 
                                                padding-left: 0;
                                                list-style: none;
                                            }
                                            .prose li { 
                                                margin-bottom: 0.625rem;
                                                line-height: 1.7;
                                                padding: 0.5rem 0.75rem;
                                                background: white;
                                                border-left: 3px solid #cbd5e1;
                                                border-radius: 0.375rem;
                                            }
                                            .prose li strong {
                                                color: #0f172a;
                                                font-weight: 700;
                                            }
                                            .prose code {
                                                background: #f1f5f9;
                                                padding: 0.125rem 0.375rem;
                                                border-radius: 0.25rem;
                                                font-size: 0.875em;
                                                color: #475569;
                                            }
                                        `}</style>
                                        <div dangerouslySetInnerHTML={{ __html: marked.parse(analysis) }}></div>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="bg-slate-50 p-3 text-[10px] text-slate-400 text-center border-t">
                            âš ï¸ Data is anonymized before being sent to Gemini AI for analysis.
                        </div>
                    </div>
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âœ… VALIDATORS & BUSINESS LOGIC
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Translates app-internal tags to expected PAR pay code labels
         * @param {Array<string>} tags - Internal tags like ['Base', 'Diff', 'Hold']
         * @returns {Array<string>} Expected PAR codes like ['NF Holdover']
         */
        const getExpectedCodes = (tags) => {
            const accepted = [];
            if (tags.includes('Mando')) {
                accepted.push('NF Mandatory');
            } else if (tags.includes('Hold')) {
                accepted.push('NF Holdover');
            } else if (tags.includes('Meal Bonus')) {
                accepted.push('NF No Break');
            } else if (tags.includes('Sick/PTO')) {
                accepted.push('Paid Time Off (PTO)');
                accepted.push('Sick');
            } else if (tags.includes('Hol')) {
                accepted.push('NF Holiday');
                accepted.push('Holiday');
            } else if (tags.includes('OT')) {
                accepted.push('Overtime');
                accepted.push('Overtime Unsch');
            } else {
                // Base / Regular
                accepted.push('Regular');
                accepted.push('Regular Unsch');
                accepted.push('Regular XSHFT');
                accepted.push('Non Unit');
                accepted.push('Train Reg');
                accepted.push('Meeting');
            }
            return accepted;
        };
        
        /**
         * Normalizes PAR codes for consistent grouping/comparison
         * Maps various spellings/formats to canonical keys (REGULAR, MANDO, HOLDOVER, etc.)
         * @param {string} code - Raw PAR code from payroll report
         * @returns {string} Normalized uppercase key
         */
        const normalizeCodeForComparison = (code) => {
            const c = code.toLowerCase();
            if (c.includes('regular') || c.includes('base') || c.includes('non unit') || c.includes('train reg')) return 'REGULAR';
            if (c.includes('mandatory') || c.includes('mando')) return 'MANDO';
            if (c.includes('holdover') || c.includes('hold')) return 'HOLDOVER';
            if (c.includes('no break') || c.includes('meal')) return 'MEAL';
            if (c.includes('holiday') || c.includes('hol')) return 'HOLIDAY';
            if (c.includes('overtime') || c.includes('ot')) return 'OVERTIME';
            if (c.includes('sick') || c.includes('pto')) return 'PTO';
            return c.toUpperCase();
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“… UI COMPONENTS - DAILY ROW (Shift Summary & Reconciliation)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * ReconciliationGrid Sub-Component
         * Displays line-by-line breakdown comparing user's calculated hours vs PAR data
         * @component
         */
        const ReconciliationGrid = ({ projectedMap, actualMap, allKeys, matchStatus }) => {
            return (
                <div className="bg-white rounded border border-slate-200 overflow-hidden overflow-x-auto">
                    {/* Desktop Header */}
                    <div className="hidden sm:grid grid-cols-12 gap-2 bg-slate-100 p-2 text-[9px] font-bold text-slate-500 uppercase">
                        <div className="col-span-4">Code</div>
                        <div className="col-span-3 text-center">My Hrs</div>
                        <div className="col-span-3 text-center">PAR Hrs</div>
                        <div className="col-span-2 text-right">Status</div>
                    </div>
                    
                    {/* Line Items */}
                    {Array.from(allKeys).sort().map(key => {
                        const proj = projectedMap[key] || { hours: 0, actualHours: 0, total: 0, label: key, rates: new Set(), isDoubled: false };
                        const act = actualMap[key] || { hours: 0, total: 0, label: '-', rates: new Set() };
                        
                        const myDisplayHours = proj.isDoubled ? proj.actualHours : proj.hours;
                        const hoursDiff = act.hours - myDisplayHours;
                        const costDiff = act.total - proj.total;
                        
                        const lineMatch = Math.abs(costDiff) < 2.0 && Math.abs(hoursDiff) < 0.3;
                        
                        let rowBg = 'bg-white', statusColor = 'text-slate-500', statusText = 'â‰ˆ', statusIcon = null, borderLeft = '';
                        
                        if (lineMatch) {
                            statusText = 'âœ“ Match';
                            statusColor = 'text-emerald-600';
                            statusIcon = <Icons.CheckCircle className="w-3 h-3 text-emerald-500"/>;
                            borderLeft = 'border-l-2 border-emerald-400';
                        } else {
                            if (matchStatus === 'match') {
                                rowBg = 'bg-blue-50/30';
                                statusColor = 'text-blue-700';
                                borderLeft = 'border-l-2 border-blue-300';
                                statusIcon = <Icons.Info className="w-3 h-3 text-blue-500"/>;
                            } else {
                                rowBg = 'bg-amber-50/50';
                                statusColor = 'text-amber-700';
                                borderLeft = 'border-l-2 border-amber-400';
                                statusIcon = <Icons.AlertTriangle className="w-3 h-3 text-amber-500"/>;
                            }
                            
                            if (Math.abs(costDiff) > 2.0) {
                                statusText = `${costDiff > 0 ? '+ ' : ''}${formatMoney(costDiff)}`;
                            } else if (Math.abs(hoursDiff) > 0.3) {
                                statusText = `${hoursDiff > 0 ? '+' : ''}${hoursDiff.toFixed(1)}h`;
                            } else {
                                statusText = 'Minor diff';
                            }
                        }

                        const displayLabel = act.label !== '-' ? act.label : proj.label;

                        return (
                            <div key={key} className={`border-b border-slate-100 ${rowBg} ${borderLeft} transition-all hover:bg-opacity-70`}>
                                {/* Desktop Grid View */}
                                <div className="hidden sm:grid grid-cols-12 gap-2 p-3 text-[10px] items-center">
                                    <div className="col-span-4 font-bold text-slate-700 truncate flex items-center gap-2" title={displayLabel}>
                                        {statusIcon}
                                        <span>{displayLabel}</span>
                                    </div>
                                    <div className="col-span-3 text-center">
                                        <div className="font-mono text-slate-600 bg-teal-50 px-2 py-1 rounded">
                                            {proj.isDoubled ? proj.actualHours.toFixed(1) : proj.hours.toFixed(1)}h
                                            {proj.isDoubled && (
                                                <span className="text-[8px] text-teal-500 ml-1" title={`${proj.actualHours.toFixed(1)}h worked â†’ ${proj.hours.toFixed(1)}h payable (doubled)`}>
                                                    Ã—2
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    <div className="col-span-3 text-center">
                                        <div className="font-mono text-slate-600 bg-emerald-50 px-2 py-1 rounded">{act.hours.toFixed(1)}h</div>
                                    </div>
                                    <div className={`col-span-2 text-right font-bold text-xs ${statusColor} flex items-center justify-end gap-1`}>
                                        <span>{statusText}</span>
                                    </div>
                                </div>
                                
                                {/* Mobile Stacked View */}
                                <div className="sm:hidden p-3 space-y-2">
                                    <div className="font-bold text-slate-700 text-xs mb-2 flex items-center gap-2">
                                        {statusIcon}
                                        <span>{displayLabel}</span>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 text-[10px]">
                                        <div className="text-center">
                                            <div className="text-slate-400 uppercase text-[8px] mb-1">My Hrs</div>
                                            <div className="font-mono text-slate-600 bg-teal-50 px-2 py-1 rounded">
                                                {proj.isDoubled ? proj.actualHours.toFixed(1) : proj.hours.toFixed(1)}
                                                {proj.isDoubled && <span className="text-[8px] text-teal-500 ml-0.5">Ã—2</span>}
                                            </div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-slate-400 uppercase text-[8px] mb-1">PAR Hrs</div>
                                            <div className="font-mono text-slate-600 bg-emerald-50 px-2 py-1 rounded">{act.hours.toFixed(1)}</div>
                                        </div>
                                        <div className="text-center">
                                            <div className="text-slate-400 uppercase text-[8px] mb-1">Status</div>
                                            <div className={`font-bold text-[9px] ${statusColor} px-1 py-1 rounded`}>{statusText}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        /**
         * ValidationSummary Sub-Component  
         * Displays total hours and pay comparison - the primary validation that actually matters
         * @component
         */
        const ValidationSummary = ({ matchStatus, myTotalHours, reportData, totalPay, diffHours, diff, hint }) => {
            return (
                <>
                    <div className={`mt-3 rounded border-2 p-3 ${matchStatus === 'match' ? 'bg-emerald-50 border-emerald-300' : 'bg-red-50 border-red-300'}`}>
                        <div className="flex items-center gap-2 mb-2">
                            <div className="text-[10px] font-bold text-slate-600 uppercase">Validation Summary</div>
                            <div className="text-[9px] text-slate-500 font-normal italic">(What Actually Matters)</div>
                        </div>
                        <div className="grid grid-cols-2 gap-4 text-xs">
                            {/* Total Hours */}
                            <div>
                                <div className="text-slate-500 text-[10px] mb-1">Total Hours</div>
                                <div className="flex items-center gap-1 mb-1">
                                    <div className="flex-1 text-center">
                                        <div className="text-[8px] text-teal-600 font-bold uppercase">My Calc</div>
                                    </div>
                                    <div className="w-4"></div>
                                    <div className="flex-1 text-center">
                                        <div className="text-[8px] text-emerald-600 font-bold uppercase">PAR Actual</div>
                                    </div>
                                    <div className="w-12"></div>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="font-mono text-slate-700 flex-1 text-center bg-teal-50 py-1 rounded">{myTotalHours.toFixed(2)}h</span>
                                    <Icons.ArrowRight className="w-3 h-3 text-slate-400 mx-1"/>
                                    <span className="font-mono text-slate-700 flex-1 text-center bg-emerald-50 py-1 rounded">{reportData.totalHours.toFixed(2)}h</span>
                                    <span className={`ml-2 font-bold text-xs w-12 text-right ${Math.abs(diffHours) < HOURS_TOLERANCE ? 'text-emerald-600' : 'text-red-600'}`}>
                                        {Math.abs(diffHours) < HOURS_TOLERANCE ? 'âœ“' : `${diffHours > 0 ? '+' : ''}${diffHours.toFixed(2)}h`}
                                    </span>
                                </div>
                            </div>
                            
                            {/* Total Pay */}
                            <div>
                                <div className="text-slate-500 text-[10px] mb-1">Total Pay</div>
                                <div className="flex items-center gap-1 mb-1">
                                    <div className="flex-1 text-center">
                                        <div className="text-[8px] text-teal-600 font-bold uppercase">My Calc</div>
                                    </div>
                                    <div className="w-4"></div>
                                    <div className="flex-1 text-center">
                                        <div className="text-[8px] text-emerald-600 font-bold uppercase">PAR Actual</div>
                                    </div>
                                    <div className="w-12"></div>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="font-mono text-slate-700 flex-1 text-center bg-teal-50 py-1 rounded">{formatMoney(totalPay)}</span>
                                    <Icons.ArrowRight className="w-3 h-3 text-slate-400 mx-1"/>
                                    <span className="font-mono text-slate-700 flex-1 text-center bg-emerald-50 py-1 rounded">{formatMoney(reportData.totalPay)}</span>
                                    <span className={`ml-2 font-bold text-xs w-12 text-right ${Math.abs(diff) < PAY_TOLERANCE ? 'text-emerald-600' : 'text-red-600'}`}>
                                        {Math.abs(diff) < PAY_TOLERANCE ? 'âœ“' : `${diff > 0 ? '+' : ''}${formatMoney(diff)}`}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {hint && (
                        <div className="mt-3 text-[10px] text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">
                            <span className="font-bold">ğŸ’¡ Hint:</span> {hint}
                        </div>
                    )}
                </>
            );
        };
        
        /**
         * Main component displaying a single day's shift data with reconciliation
         * Shows expandable comparison between user's calculated hours/pay vs PAR actual
         * @component
         */
        const DailyRow = ({ dayGroup, settings, onUpdate, onRemove, onAddShift, reportData, dailyCalc, isExpanded, onToggleExpand, setActiveTab }) => {
            const totalPay = dayGroup.rows.reduce((sum, r) => sum + r.total, 0);
            const myTotalHours = dailyCalc ? dailyCalc.hours : dayGroup.rows.reduce((sum, r) => sum + r.hours, 0);
            
            let matchStatus = 'none', diff = 0, diffHours = 0, hint = null, matchNote = null;

            if (reportData) {
                diff = reportData.totalPay - totalPay;
                diffHours = reportData.totalHours - myTotalHours;
                
                // Use global tolerance constants
                const hoursMatch = Math.abs(diffHours) < HOURS_TOLERANCE;
                const payMatch = Math.abs(diff) < PAY_TOLERANCE;
                
                if (hoursMatch && payMatch) {
                    matchStatus = 'match';
                    matchNote = Math.abs(diff) > 0.5 || Math.abs(diffHours) > 0.1 
                        ? "Totals match" 
                        : "Perfect match";
                } else {
                    matchStatus = 'mismatch';
                    if (!hoursMatch && !payMatch) {
                        hint = `Hours off by ${diffHours > 0 ? '+' : ''}${diffHours.toFixed(2)}h, pay off by ${formatMoney(diff)}`;
                    } else if (!hoursMatch) {
                        hint = `Hours: ${diffHours > 0 ? '+' : ''}${diffHours.toFixed(2)}h difference`;
                    } else {
                        hint = `Pay: ${diff > 0 ? '+' : ''}${formatMoney(diff)} difference`;
                    }
                }
            }
            
            const timeDisplay = dayGroup.shifts.length > 0 && !dayGroup.shifts[0].isPaidLeave
                ? `${dayGroup.shifts[0].startTime} â†’ ${dayGroup.shifts[0].endTime}`
                : dayGroup.shifts[0]?.isPaidLeave ? 'PTO/Sick' : '--';
            
            // Prepare projection maps for reconciliation
            const projectedMap = {};
            dayGroup.rows.forEach(r => {
                const code = getExpectedCodes(r.tags)[0]; 
                const key = normalizeCodeForComparison(code);
                if (!projectedMap[key]) projectedMap[key] = { label: code, hours: 0, actualHours: 0, total: 0, rates: new Set(), isDoubled: false };
                projectedMap[key].hours += r.hours;
                projectedMap[key].actualHours += (r.actualHours || r.hours);
                projectedMap[key].total += r.total;
                projectedMap[key].isDoubled = projectedMap[key].isDoubled || r.isDoubledHours;
                if (r.rate) projectedMap[key].rates.add(r.rate);
            });

            const actualMap = {};
            if (reportData) {
                reportData.entries.forEach(e => {
                    const key = normalizeCodeForComparison(e.code);
                    if (!actualMap[key]) actualMap[key] = { label: e.code, hours: 0, total: 0, rates: new Set() };
                    actualMap[key].hours += e.hours;
                    actualMap[key].total += e.amount;
                    actualMap[key].rates.add(e.rate);
                });
            }
            const allKeys = new Set([...Object.keys(projectedMap), ...Object.keys(actualMap)]);

            // Determine if row should be expanded
            const showExpanded = isExpanded !== undefined ? isExpanded : (matchStatus === 'mismatch');

            let statusBadge = { bg: 'bg-slate-100', text: 'text-slate-500', label: 'No Data', icon: null };
            if (matchStatus === 'match') {
                statusBadge = { 
                    bg: 'bg-emerald-50', text: 'text-emerald-700', label: 'Match',
                    icon: <Icons.CheckCircle className="w-3.5 h-3.5"/>
                };
            } else if (matchStatus === 'mismatch') {
                statusBadge = { 
                    bg: 'bg-red-50', text: 'text-red-700', label: 'Alert',
                    icon: <Icons.AlertTriangle className="w-3.5 h-3.5"/>
                };
            }

            return (
                <div className={`bg-white border-b border-slate-100 transition-all relative ${showExpanded ? 'ring-2 ring-indigo-300 shadow-xl z-[5]' : 'hover:shadow-sm'}`}>
                    {/* RESPONSIVE TABLE ROW */}
                    <div 
                        onClick={onToggleExpand}
                        className={`group cursor-pointer transition-all ${showExpanded ? 'bg-teal-50' : 'hover:bg-slate-50/50'}`}
                    >
                        {/* DESKTOP VIEW: Grid Layout */}
                        <div className="hidden md:grid grid-cols-12 gap-3 px-6 py-4 items-center">
                        {/* Column 1: Date */}
                        <div className="col-span-2">
                            <div className="font-bold text-slate-900 text-sm">{new Date(dayGroup.date + 'T12:00:00').toLocaleDateString('en-US', {weekday: 'short', month:'short', day:'numeric'})}</div>
                            <div className="text-[10px] text-slate-400 font-mono mt-0.5">{timeDisplay}</div>
                        </div>

                        {/* Column 2: My Hours */}
                        <div className="col-span-2 text-center">
                            <div className="text-[10px] text-slate-400 uppercase tracking-wide mb-0.5">My Hours</div>
                            <div className="font-mono font-bold text-slate-700 text-sm">{myTotalHours.toFixed(1)}h</div>
                    </div>

                        {/* Column 3: PAR Hours */}
                        <div className="col-span-2 text-center">
                            <div className="text-[10px] text-slate-400 uppercase tracking-wide mb-0.5">PAR Hours</div>
                            <div className="font-mono font-bold text-slate-700 text-sm">{reportData ? `${reportData.totalHours.toFixed(1)}h` : 'â€”'}</div>
                        </div>

                        {/* Column 4: My Pay */}
                        <div className="col-span-2 text-right">
                            <div className="text-[10px] text-slate-400 uppercase tracking-wide mb-0.5">My Calc</div>
                                <div className="font-mono font-bold text-teal-600">{formatMoney(totalPay)}</div>
                        </div>

                        {/* Column 5: PAR Pay */}
                        <div className="col-span-2 text-right">
                            <div className="text-[10px] text-slate-400 uppercase tracking-wide mb-0.5">Actual</div>
                            <div className="font-mono font-bold text-emerald-600">{reportData ? formatMoney(reportData.totalPay) : 'â€”'}</div>
                        </div>

                        {/* Column 6: Status Badge */}
                        <div className="col-span-2 flex justify-end items-center gap-2">
                            <div className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full ${statusBadge.bg} ${statusBadge.text} font-bold text-xs shadow-sm`}>
                                {statusBadge.icon}
                                <span>{statusBadge.label}</span>
                            </div>
                                <div className="text-slate-300 group-hover:text-teal-400 transition-colors">
                                {showExpanded ? <Icons.ChevronUp className="w-4 h-4"/> : <Icons.ChevronDown className="w-4 h-4"/>}
                                            </div>
                                    </div>
                                    </div>

                        {/* MOBILE VIEW: Compact Card */}
                        <div className="md:hidden px-4 py-3">
                            <div className="flex items-center justify-between mb-2">
                                <div className="flex-1">
                                    <div className="font-bold text-slate-900 text-base">{new Date(dayGroup.date + 'T12:00:00').toLocaleDateString('en-US', {weekday: 'short', month:'short', day:'numeric'})}</div>
                                    <div className="text-xs text-slate-500 font-mono mt-0.5">{timeDisplay}</div>
                                </div>
                                <div className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full ${statusBadge.bg} ${statusBadge.text} font-bold text-xs shadow-sm`}>
                                    {statusBadge.icon}
                                    <span className="hidden sm:inline">{statusBadge.label}</span>
                    </div>
                    </div>
                            
                            <div className="grid grid-cols-2 gap-3 text-sm">
                                <div className="bg-slate-50 rounded-lg p-2">
                                    <div className="text-[10px] text-slate-500 uppercase tracking-wide mb-1">My Calc</div>
                                    <div className="font-mono font-bold text-teal-600">{formatMoney(totalPay)}</div>
                                    <div className="text-xs text-slate-400 font-mono mt-0.5">{myTotalHours.toFixed(1)}h</div>
                                </div>
                                <div className="bg-slate-50 rounded-lg p-2">
                                    <div className="text-[10px] text-slate-500 uppercase tracking-wide mb-1">Actual</div>
                                    <div className="font-mono font-bold text-emerald-600">{reportData ? formatMoney(reportData.totalPay) : 'â€”'}</div>
                                    <div className="text-xs text-slate-400 font-mono mt-0.5">{reportData ? `${reportData.totalHours.toFixed(1)}h` : 'â€”'}</div>
                                </div>
                            </div>

                            <div className="flex justify-center mt-2">
                                <div className="text-slate-300 group-hover:text-teal-400 transition-colors">
                                    {showExpanded ? <Icons.ChevronUp className="w-5 h-5"/> : <Icons.ChevronDown className="w-5 h-5"/>}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* EXPANDABLE EDIT PANEL */}
                    <div className={`${showExpanded ? 'block' : 'hidden'} expandable-row bg-gradient-to-br from-teal-50 via-white to-slate-50/30 border-t-4 border-teal-300 shadow-inner max-h-[70vh] overflow-y-auto px-3 md:px-6 py-4 md:py-6 print:block print:max-h-none print:overflow-visible`}>
                            <div className="max-w-6xl mx-auto">
                                {/* Header Actions */}
                                <div className="flex flex-col sm:flex-row justify-between items-stretch sm:items-center gap-3 mb-4">
                                    <h4 className="text-xs md:text-sm font-bold text-slate-600 uppercase tracking-wider">Edit Shift Details</h4>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); onAddShift(dayGroup.date); }} 
                                            className="px-3 py-1.5 bg-teal-500 hover:bg-teal-600 text-white text-xs font-bold rounded-lg flex items-center gap-1.5 transition-colors shadow-sm"
                                        >
                                            <Icons.Plus className="w-3.5 h-3.5"/> Add Shift
                                        </button>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); if(confirm('Delete this day?')) onRemove(null, dayGroup.date); }} 
                                            className="px-3 py-1.5 bg-white hover:bg-red-50 text-red-600 text-xs font-bold rounded-lg border border-red-200 flex items-center gap-1.5 transition-colors"
                                        >
                                            <Icons.Trash2 className="w-3.5 h-3.5"/> Delete Day
                                        </button>
                                    </div>
                                </div>

                                {/* Classification Agreement Checker */}
                                {reportData && (
                                    <div className="mb-6 bg-white rounded-lg border-2 border-slate-200 p-4 shadow-sm">
                                        <div className="text-xs font-bold text-slate-600 uppercase tracking-wider mb-3 flex items-center gap-2">
                                            <Icons.CheckCircle className="w-4 h-4 text-teal-500"/>
                                            Classification Agreement
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {(() => {
                                                const userClaims = {
                                                    mando: dayGroup.shifts.some(s => s.isMando),
                                                    holdover: dayGroup.shifts.some(s => s.isHoldover),
                                                    holiday: dayGroup.shifts.some(s => s.isHoliday),
                                                    meal: dayGroup.shifts.some(s => s.claimFreeHour),
                                                    pto: dayGroup.shifts.some(s => s.isPaidLeave)
                                                };
                                                
                                                const parHas = {
                                                    mando: reportData.entries.some(e => e.code.toLowerCase().includes('mandatory')),
                                                    holdover: reportData.entries.some(e => e.code.toLowerCase().includes('holdover')),
                                                    holiday: reportData.entries.some(e => e.code.toLowerCase().includes('holiday')),
                                                    meal: reportData.entries.some(e => e.code.toLowerCase().includes('no break') || e.code.toLowerCase().includes('meal')),
                                                    pto: reportData.entries.some(e => e.code.toLowerCase().includes('pto') || e.code.toLowerCase().includes('sick'))
                                                };

                                                const checks = [
                                                    { label: 'Mando', user: userClaims.mando, par: parHas.mando },
                                                    { label: 'Holdover', user: userClaims.holdover, par: parHas.holdover },
                                                    { label: 'Holiday', user: userClaims.holiday, par: parHas.holiday },
                                                    { label: 'Meal Bonus', user: userClaims.meal, par: parHas.meal },
                                                    { label: 'PTO/Sick', user: userClaims.pto, par: parHas.pto }
                                                ];

                                                return checks.map(check => {
                                                    if (!check.user && !check.par) return null; // Both agree it's not there, don't show
                                                    
                                                    const agreed = check.user === check.par;
                                                    const icon = agreed ? 'âœ“' : 'âš ';
                                                    const bgColor = agreed ? 'bg-emerald-50 border-emerald-300 text-emerald-700' : 'bg-amber-50 border-amber-300 text-amber-700';
                                                    
                                                    let status = '';
                                                    if (agreed && check.user) {
                                                        status = 'Both agree';
                                                    } else if (check.user && !check.par) {
                                                        status = 'You claimed, PAR missing';
                                                    } else if (!check.user && check.par) {
                                                        status = 'PAR paid, you didn\'t claim';
                                                    }

                                                    return (
                                                        <div key={check.label} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border text-xs font-bold ${bgColor}`}>
                                                            <span>{icon}</span>
                                                            <span>{check.label}</span>
                                                            <span className="text-[10px] opacity-75">Â· {status}</span>
                                                        </div>
                                                    );
                                                }).filter(Boolean);
                                            })()}
                                        </div>
                                        {(() => {
                                            const userClaims = {
                                                mando: dayGroup.shifts.some(s => s.isMando),
                                                holdover: dayGroup.shifts.some(s => s.isHoldover),
                                                holiday: dayGroup.shifts.some(s => s.isHoliday),
                                                meal: dayGroup.shifts.some(s => s.claimFreeHour),
                                                pto: dayGroup.shifts.some(s => s.isPaidLeave)
                                            };
                                            const parHas = {
                                                mando: reportData.entries.some(e => e.code.toLowerCase().includes('mandatory')),
                                                holdover: reportData.entries.some(e => e.code.toLowerCase().includes('holdover')),
                                                holiday: reportData.entries.some(e => e.code.toLowerCase().includes('holiday')),
                                                meal: reportData.entries.some(e => e.code.toLowerCase().includes('no break') || e.code.toLowerCase().includes('meal')),
                                                pto: reportData.entries.some(e => e.code.toLowerCase().includes('pto') || e.code.toLowerCase().includes('sick'))
                                            };
                                            const allMatch = Object.keys(userClaims).every(k => userClaims[k] === parHas[k]);
                                            const hasAny = Object.keys(userClaims).some(k => userClaims[k] || parHas[k]);
                                            
                                            if (!hasAny) {
                                                return <div className="text-xs text-slate-500 italic mt-2">ğŸ“‹ Regular shift (no special modifiers)</div>;
                                            }
                                            if (allMatch) {
                                                return <div className="text-xs text-emerald-600 font-bold mt-2">âœ… All classifications match perfectly</div>;
                                            }
                                        })()}
                                    </div>
                                )}

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                                    {/* LEFT: Shift Editor */}
                                    <div>
                                        <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                            <Icons.Clipboard className="w-4 h-4"/> My Shifts
                                        </h5>
                                        <div className="space-y-3">
                                {dayGroup.shifts.map((shift) => {
                             const startD = new Date(`2000-01-01T${shift.startTime}`);
                             let endD = new Date(`2000-01-01T${shift.endTime}`);
                             if(endD <= startD) endD.setDate(endD.getDate() + 1);
                             const crossesMidnight = endD.getDate() > startD.getDate();
                             const estHours = shift.isPaidLeave ? shift.paidLeaveHours : (endD-startD)/36e5;

                             return (
                                        <div key={shift.id} className="bg-white rounded-lg p-4 border border-slate-200 shadow-sm hover:shadow-md transition-shadow relative group">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onRemove(shift.id); }} 
                                                className="absolute -top-2 -right-2 bg-white border border-red-200 text-red-500 hover:bg-red-50 hover:text-red-700 rounded-full p-1 opacity-0 group-hover:opacity-100 transition-all shadow-sm"
                                            >
                                                <Icons.X className="w-3.5 h-3.5"/>
                                            </button>
                                            
                                        {shift.isPaidLeave ? (
                                                <div className="flex items-center gap-3 mb-3">
                                                    <span className="font-bold text-teal-600 text-sm">PTO/Sick</span>
                                                    <input 
                                                        type="number" 
                                                        value={shift.paidLeaveHours} 
                                                        onChange={(e) => { e.stopPropagation(); onUpdate(shift.id, 'paidLeaveHours', parseFloat(e.target.value) || 0); }} 
                                                        className="w-20 bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                    />
                                                    <span className="text-slate-400 text-xs font-medium">hours</span>
                                            </div>
                                        ) : (
                                                <div className="flex items-center gap-2 mb-3">
                                                    <input 
                                                        type="time" 
                                                        value={shift.startTime} 
                                                        onChange={(e) => { e.stopPropagation(); onUpdate(shift.id, 'startTime', e.target.value); }} 
                                                        className="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                    />
                                                    <Icons.ArrowRight className="w-4 h-4 text-slate-300 flex-shrink-0"/>
                                                    <div className="relative flex-1">
                                                        <input 
                                                            type="time" 
                                                            value={shift.endTime} 
                                                            onChange={(e) => { e.stopPropagation(); onUpdate(shift.id, 'endTime', e.target.value); }} 
                                                            className="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
                                                        />
                                                        {crossesMidnight && <span className="absolute -top-1.5 -right-1.5 bg-indigo-600 text-white text-[8px] font-bold px-1.5 py-0.5 rounded-full shadow-sm">+1</span>}
                                                </div>
                                                    <span className="font-mono text-xs text-slate-500 font-medium min-w-[3rem] text-right">{estHours.toFixed(2)}h</span>
                                            </div>
                                        )}
                                            
                                            <div className="flex flex-wrap gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); onUpdate(shift.id, 'isPaidLeave', !shift.isPaidLeave); }} className={`px-2.5 py-1 text-[10px] font-bold rounded-md transition-all ${shift.isPaidLeave ? 'bg-teal-500 text-white shadow-sm' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>PTO</button>
                                        {!shift.isPaidLeave && (
                                            <>
                                                        <button onClick={(e) => { e.stopPropagation(); onUpdate(shift.id, 'isHoliday', !shift.isHoliday); }} className={`px-2.5 py-1 text-[10px] font-bold rounded-md transition-all ${shift.isHoliday ? 'bg-purple-500 text-white shadow-sm' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>HOL</button>
                                                        <button onClick={(e) => { e.stopPropagation(); onUpdate(shift.id, 'claimFreeHour', !shift.claimFreeHour); }} className={`px-2.5 py-1 text-[10px] font-bold rounded-md transition-all ${shift.claimFreeHour ? 'bg-amber-500 text-white shadow-sm' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>C7</button>
                                                        <button onClick={(e) => { e.stopPropagation(); onUpdate(shift.id, 'isHoldover', !shift.isHoldover); }} className={`px-2.5 py-1 text-[10px] font-bold rounded-md transition-all ${shift.isHoldover ? 'bg-orange-500 text-white shadow-sm' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>HOLD</button>
                                                        <button onClick={(e) => { e.stopPropagation(); onUpdate(shift.id, 'isMando', !shift.isMando); }} className={`px-2.5 py-1 text-[10px] font-bold rounded-md transition-all ${shift.isMando ? 'bg-red-500 text-white shadow-sm' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>MANDO</button>
                                            </>
                                        )}
                                    </div>
                                </div>
                             );
                        })}
                    </div>
                    </div>

                        {/* RIGHT: Official PAR Data */}
                        <div>
                            <h5 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <Icons.FileText className="w-4 h-4"/> Official Payroll (PAR)
                            </h5>
                            {reportData ? (
                                <div className="bg-white rounded-lg p-4 border border-slate-200 shadow-sm">
                                    <div className="space-y-2 mb-4">
                                        {reportData.entries.map((entry, idx) => (
                                            <div key={idx} className="flex justify-between items-center text-xs py-2 border-b border-slate-100 last:border-0">
                                                <span className="text-slate-700 font-medium truncate flex-1" title={entry.code}>{entry.code}</span>
                                                <span className="font-mono text-slate-500 text-[11px] ml-3">{entry.hours.toFixed(1)}h Ã— ${entry.rate.toFixed(2)}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex justify-between items-center pt-3 border-t-2 border-emerald-200">
                                        <span className="font-bold text-sm text-slate-700">Actual Total</span>
                                        <span className="font-bold text-lg text-emerald-600">{formatMoney(reportData.totalPay)}</span>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-lg p-6 border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-center min-h-[200px]">
                                    <Icons.Clipboard className="w-10 h-10 text-slate-300 mb-3"/>
                                    <p className="text-sm text-slate-500 font-medium mb-1">No PAR Data</p>
                                    <p className="text-xs text-slate-400 mb-4">Import payroll report to validate</p>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); setActiveTab('import'); }} 
                                        className="px-4 py-2 bg-teal-500 hover:bg-indigo-600 text-white text-xs font-bold rounded-lg transition-colors"
                                    >
                                        Import Report
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* EXPANDABLE DETAIL: Reconciliation Grid */}
                    {reportData && (
                        <div className="border-t border-slate-200 bg-slate-50 p-3 md:p-4 mt-4 no-page-break">
                            <div className="mb-3">
                                <div className="text-xs font-bold text-slate-600 flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                    <Icons.Grid className="w-4 h-4"/>
                                    Line-by-Line Breakdown
                                </div>
                                    <div className="flex items-center gap-3 text-[9px] font-normal">
                                        <div className="flex items-center gap-1">
                                            <div className="w-3 h-3 bg-teal-50 border border-indigo-200 rounded"></div>
                                            <span className="text-indigo-700">My Calc</span>
                                </div>
                                        <div className="flex items-center gap-1">
                                            <div className="w-3 h-3 bg-emerald-50 border border-emerald-200 rounded"></div>
                                            <span className="text-emerald-700">PAR Data</span>
                            </div>
                                </div>
                                                    </div>
                                {matchStatus === 'match' ? (
                                    <div className="text-[10px] text-emerald-700 bg-emerald-50 border border-emerald-200 rounded p-2.5 mb-1 flex items-start gap-2">
                                        <Icons.CheckCircle className="w-3.5 h-3.5 mt-0.5 flex-shrink-0"/>
                                    <div>
                                            <div className="font-bold mb-0.5">âœ“ Totals Match - You're Good!</div>
                                            <div className="text-emerald-600 leading-relaxed">PAR may classify hours differently (e.g., Regular vs Holdover), but your <strong>total hours and pay align</strong>. Line differences below are informational only.</div>
                                </div>
                        </div>
                                ) : (
                                    <div className="text-[10px] text-red-700 bg-red-50 border border-red-200 rounded p-2.5 mb-1 flex items-start gap-2">
                                        <Icons.AlertTriangle className="w-3.5 h-3.5 mt-0.5 flex-shrink-0"/>
                                    <div>
                                            <div className="font-bold mb-0.5">âš ï¸ Total Mismatch Detected</div>
                                            <div className="text-red-600 leading-relaxed">Your calculated totals don't match PAR. Review the breakdown below to find discrepancies.</div>
                                        </div>
                                    </div>
                                )}
                                </div>
                            <ReconciliationGrid 
                                projectedMap={projectedMap} 
                                actualMap={actualMap} 
                                allKeys={allKeys} 
                                matchStatus={matchStatus} 
                            />

                            <ValidationSummary 
                                matchStatus={matchStatus}
                                myTotalHours={myTotalHours}
                                reportData={reportData}
                                totalPay={totalPay}
                                diffHours={diffHours}
                                diff={diff}
                                hint={hint}
                            />
                                </div>
                            )}
                        </div>
                                </div>
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ“± UI COMPONENTS - VIEWS (Import, Report, Release Notes, Help)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Welcome Modal - First-time user onboarding
         * @component
         */
        const WelcomeModal = ({ onClose }) => {
            const handleStart = () => {
                localStorage.setItem('hasVisited', 'true');
                onClose();
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={handleStart}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full animate-in zoom-in" onClick={(e) => e.stopPropagation()}>
                        {/* Header */}
                        <div className="bg-gradient-to-r from-teal-500 to-emerald-500 text-white p-6 rounded-t-2xl">
                            <div className="flex items-center justify-center mb-3">
                                <svg width="48" height="48" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 2L6 6V14C6 20.5 10 26.5 16 29C22 26.5 26 20.5 26 14V6L16 2Z" fill="white"/>
                                    <path d="M11 16L14 19L21 11" stroke="#14B8A6" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                                </svg>
                            </div>
                            <h2 className="text-2xl font-bold text-center">Welcome to CoCo ShadowLedger!</h2>
                            <p className="text-teal-100 text-center text-sm mt-1">Protect Your Paycheck</p>
                        </div>
                        
                        {/* Content */}
                        <div className="p-6 space-y-5">
                            {/* What is this */}
                            <div>
                                <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                    <Icons.HelpCircle className="w-5 h-5 text-teal-600"/>
                                    What is this?
                                </h3>
                                <p className="text-slate-600 text-sm leading-relaxed">
                                    A tool that helps <strong>AMR Paramedics & EMTs</strong> verify their paychecks are accurate by comparing punch data against official payroll records.
                                </p>
                            </div>
                            
                            {/* Why you need it */}
                            <div>
                                <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                    <Icons.AlertTriangle className="w-5 h-5 text-amber-500"/>
                                    Why you need it
                                </h3>
                                <ul className="text-slate-600 text-sm space-y-1">
                                    <li className="flex items-start gap-2">
                                        <span className="text-amber-500 mt-0.5">â€¢</span>
                                        <span><strong>Mandos</strong> sometimes counted as regular pay</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-amber-500 mt-0.5">â€¢</span>
                                        <span><strong>Holiday pay</strong> missing</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-amber-500 mt-0.5">â€¢</span>
                                        <span><strong>Missed meals</strong> not paid</span>
                                    </li>
                                </ul>
                            </div>
                            
                            {/* How it works */}
                            <div>
                                <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                    <Icons.CheckCircle className="w-5 h-5 text-emerald-500"/>
                                    How it works
                                </h3>
                                <ol className="text-slate-600 text-sm space-y-2">
                                    <li className="flex items-start gap-3">
                                        <span className="bg-teal-100 text-teal-700 font-bold rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0">1</span>
                                        <span className="pt-0.5">Set your base hourly rate</span>
                                    </li>
                                    <li className="flex items-start gap-3">
                                        <span className="bg-teal-100 text-teal-700 font-bold rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0">2</span>
                                        <span className="pt-0.5">Import your Kronos timecard</span>
                                    </li>
                                    <li className="flex items-start gap-3">
                                        <span className="bg-teal-100 text-teal-700 font-bold rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0">3</span>
                                        <span className="pt-0.5">Import your ServiceNow payroll report</span>
                                    </li>
                                    <li className="flex items-start gap-3">
                                        <span className="bg-emerald-100 text-emerald-700 font-bold rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0">âœ“</span>
                                        <span className="pt-0.5">See if your paycheck matches!</span>
                                    </li>
                                </ol>
                            </div>
                            
                            {/* Key benefits */}
                            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                <div className="flex items-center gap-2 text-emerald-800 text-sm">
                                    <Icons.Lock className="w-4 h-4 flex-shrink-0"/>
                                    <span><strong>Private & Secure:</strong> All data stays on your device</span>
                                </div>
                                <div className="flex items-center gap-2 text-emerald-800 text-sm mt-1.5">
                                    <Icons.Clock className="w-4 h-4 flex-shrink-0"/>
                                    <span><strong>Quick Setup:</strong> Takes about 5 minutes</span>
                                </div>
                            </div>
                        </div>
                        
                        {/* Footer Actions */}
                        <div className="p-6 pt-0 space-y-3">
                            <button 
                                onClick={handleStart}
                                className="w-full bg-gradient-to-r from-teal-500 to-emerald-500 hover:from-teal-600 hover:to-emerald-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all transform hover:scale-105"
                            >
                                Let's Get Started! ğŸš€
                            </button>
                            <button 
                                onClick={handleStart}
                                className="w-full text-slate-500 hover:text-slate-700 text-sm py-2 transition-colors"
                            >
                                Skip intro
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        /**
         * Import View - Handles timecard and payroll report data import
         * @component
         */
        const ImportView = ({ importMode, setImportMode, importText, setImportText, handleImport, settings, setSettings }) => {
            const [showTutorial, setShowTutorial] = useState(false);
            const [showPrivacyInfo, setShowPrivacyInfo] = useState(false);
            const [entryMode, setEntryMode] = useState('paste'); // 'paste' or 'manual'
            const [manualShift, setManualShift] = useState({
                date: new Date().toISOString().split('T')[0],
                startTime: '07:00',
                endTime: '19:00',
                mando: false,
                holiday: false,
                missedMeal: false,
                holdover: false
            });

            return (
                <div className="space-y-6">
                    {/* Base Rate Setup - First Thing Users See */}
                    <div className="bg-gradient-to-br from-emerald-50 to-teal-50 border-2 border-emerald-300 rounded-xl p-5 shadow-md">
                        <div className="flex items-start gap-4">
                            <div className="bg-emerald-500 rounded-full p-2.5 mt-0.5">
                                <Icons.DollarSign className="w-5 h-5 text-white" />
                            </div>
                            <div className="flex-1">
                                <h3 className="font-bold text-emerald-900 text-lg mb-1">Step 0: Set Your Base Hourly Rate</h3>
                                <p className="text-emerald-800 text-sm mb-3 opacity-90">
                                    This is the starting point for all calculations. Find it on your pay stub or offer letter.
                                </p>
                                <div className="flex items-center gap-3">
                                    <div className="flex items-baseline gap-2 bg-white px-5 py-3 rounded-lg border-2 border-emerald-400 shadow-sm">
                                        <span className="text-emerald-600 font-bold text-2xl">$</span>
                                        <input 
                                            type="number" 
                                            step="0.01"
                                            min="0"
                                            value={settings.baseRate} 
                                            onChange={(e) => setSettings({...settings, baseRate: parseFloat(e.target.value) || 0})} 
                                            className="w-28 bg-transparent font-bold text-slate-900 text-2xl outline-none border-b-2 border-transparent focus:border-emerald-500 transition-colors pr-1"
                                            placeholder="40.00"
                                        />
                                        <span className="text-slate-500 text-base font-medium">/hr</span>
                                    </div>
                                    {settings.baseRate > 0 && (
                                        <div className="flex items-center gap-1.5 text-emerald-700 text-sm font-medium animate-in fade-in slide-in-from-left-2">
                                            <Icons.CheckCircle className="w-4 h-4" />
                                            <span>Looks good!</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="flex justify-center">
                        <button onClick={() => setShowPrivacyInfo(!showPrivacyInfo)} className="flex items-center gap-2 px-4 py-1.5 bg-slate-100 hover:bg-slate-200 border border-slate-200 rounded-full text-xs text-slate-600 transition-all shadow-sm">
                            <Icons.Lock className="w-3 h-3 text-emerald-600" />
                            <span className="font-bold text-emerald-700">Private & Offline</span>
                            <span className="text-slate-300">|</span>
                            <span className="underline decoration-slate-400 decoration-dotted">How is my data handled?</span>
                        </button>
                    </div>
                    {showPrivacyInfo && (
                        <div className="bg-emerald-50 border border-emerald-100 rounded-lg p-4 text-sm text-emerald-900 animate-in fade-in slide-in-from-top-2">
                            <h4 className="font-bold mb-2 flex items-center gap-2"><Icons.CheckCircle className="w-4 h-4"/> Your Data Never Leaves This Device</h4>
                            <ul className="list-disc pl-5 space-y-1 text-emerald-800 opacity-90 mb-3">
                                <li>This tool runs entirely in your browser using JavaScript.</li>
                                <li>No data is sent to any server or cloud database.</li>
                                <li>Data is saved locally to your device (LocalStorage) so you don't lose it on refresh.</li>
                            </ul>
                            <p className="text-xs text-emerald-700 font-medium"><strong>Verify it yourself:</strong> You can turn on Airplane Mode before pasting your sensitive data.</p>
                        </div>
                    )}
                    <div className="bg-teal-50 border border-indigo-200 rounded-lg p-4 text-sm text-indigo-900">
                         <h3 className="font-bold text-lg mb-2 flex items-center gap-2"><Icons.CheckCircle className="w-5 h-5"/> How to Audit Your Pay</h3>
                         <ol className="list-decimal pl-5 space-y-1">
                             <li><strong>Set Base Rate:</strong> Enter your hourly rate above â˜ï¸</li>
                             <li><strong>Import Timecard:</strong> Copy hours from Kronos.</li>
                             <li><strong>Import Payroll Report:</strong> Copy official PAR text.</li>
                             <li><strong>Validate:</strong> Go to Dashboard tab, check for green âœ“ marks.</li>
                         </ol>
                    </div>
                    <div className="bg-white p-4 rounded shadow border border-slate-200">
                        <div className="flex gap-2 mb-4">
                            <button onClick={() => setImportMode('timecard')} className={`px-4 py-2 rounded text-sm font-bold flex-1 ${importMode==='timecard'?'bg-indigo-600 text-white':'bg-slate-100 text-slate-500'}`}>1. Timecard (TC)</button>
                            <button onClick={() => setImportMode('report')} className={`px-4 py-2 rounded text-sm font-bold flex-1 ${importMode==='report'?'bg-indigo-600 text-white':'bg-slate-100 text-slate-500'}`}>2. Payroll Report (PAR)</button>
                        </div>
                        
                        {/* Entry Mode Toggle for Timecard */}
                        {importMode === 'timecard' && (
                            <div className="mb-4 flex gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                <button 
                                    onClick={() => setEntryMode('paste')} 
                                    className={`flex-1 px-3 py-2 rounded text-xs font-bold transition-all ${entryMode==='paste'?'bg-white text-slate-700 shadow-sm':'text-slate-400'}`}
                                >
                                    ğŸ“‹ Copy/Paste from Kronos
                                </button>
                                <button 
                                    onClick={() => setEntryMode('manual')} 
                                    className={`flex-1 px-3 py-2 rounded text-xs font-bold transition-all ${entryMode==='manual'?'bg-white text-slate-700 shadow-sm':'text-slate-400'}`}
                                >
                                    âœï¸ Quick Manual Entry
                                </button>
                            </div>
                        )}
                        
                        {/* Manual Entry Form */}
                        {importMode === 'timecard' && entryMode === 'manual' && (
                            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
                                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                                    <Icons.Edit className="w-5 h-5 text-blue-600"/>
                                    Add Shift Manually
                                </h3>
                                <div className="space-y-3">
                                    {/* Date */}
                                    <div>
                                        <label className="block text-xs font-bold text-slate-700 mb-1">Date</label>
                                        <input 
                                            type="date" 
                                            value={manualShift.date}
                                            onChange={(e) => setManualShift({...manualShift, date: e.target.value})}
                                            className="w-full px-3 py-2 border-2 border-slate-300 rounded-lg text-sm focus:border-blue-500 outline-none"
                                        />
                                    </div>
                                    
                                    {/* Times */}
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-700 mb-1">Start Time</label>
                                            <input 
                                                type="time" 
                                                value={manualShift.startTime}
                                                onChange={(e) => setManualShift({...manualShift, startTime: e.target.value})}
                                                className="w-full px-3 py-2 border-2 border-slate-300 rounded-lg text-sm focus:border-blue-500 outline-none"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-700 mb-1">End Time</label>
                                            <input 
                                                type="time" 
                                                value={manualShift.endTime}
                                                onChange={(e) => setManualShift({...manualShift, endTime: e.target.value})}
                                                className="w-full px-3 py-2 border-2 border-slate-300 rounded-lg text-sm focus:border-blue-500 outline-none"
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* Checkboxes */}
                                    <div>
                                        <label className="block text-xs font-bold text-slate-700 mb-2">Shift Details</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <label className="flex items-center gap-2 p-2 bg-white rounded-lg border-2 border-slate-200 cursor-pointer hover:border-orange-300 transition-colors">
                                                <input 
                                                    type="checkbox" 
                                                    checked={manualShift.mando}
                                                    onChange={(e) => setManualShift({...manualShift, mando: e.target.checked})}
                                                    className="w-4 h-4 text-orange-500"
                                                />
                                                <span className="text-sm font-medium">ğŸ”¥ Mando</span>
                                            </label>
                                            <label className="flex items-center gap-2 p-2 bg-white rounded-lg border-2 border-slate-200 cursor-pointer hover:border-red-300 transition-colors">
                                                <input 
                                                    type="checkbox" 
                                                    checked={manualShift.holiday}
                                                    onChange={(e) => setManualShift({...manualShift, holiday: e.target.checked})}
                                                    className="w-4 h-4 text-red-500"
                                                />
                                                <span className="text-sm font-medium">ğŸ‰ Holiday</span>
                                            </label>
                                            <label className="flex items-center gap-2 p-2 bg-white rounded-lg border-2 border-slate-200 cursor-pointer hover:border-yellow-300 transition-colors">
                                                <input 
                                                    type="checkbox" 
                                                    checked={manualShift.missedMeal}
                                                    onChange={(e) => setManualShift({...manualShift, missedMeal: e.target.checked})}
                                                    className="w-4 h-4 text-yellow-500"
                                                />
                                                <span className="text-sm font-medium">ğŸ” Missed Meal</span>
                                            </label>
                                            <label className="flex items-center gap-2 p-2 bg-white rounded-lg border-2 border-slate-200 cursor-pointer hover:border-purple-300 transition-colors">
                                                <input 
                                                    type="checkbox" 
                                                    checked={manualShift.holdover}
                                                    onChange={(e) => setManualShift({...manualShift, holdover: e.target.checked})}
                                                    className="w-4 h-4 text-purple-500"
                                                />
                                                <span className="text-sm font-medium">â° Holdover</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    {/* Add Button */}
                                    <button 
                                        onClick={() => {
                                            // Calculate hours
                                            const start = new Date(`${manualShift.date}T${manualShift.startTime}`);
                                            let end = new Date(`${manualShift.date}T${manualShift.endTime}`);
                                            if (end <= start) end.setDate(end.getDate() + 1);
                                            const hours = ((end - start) / (1000 * 60 * 60)).toFixed(2);
                                            
                                            // Create shift text that mimics Kronos format
                                            const shiftText = `${manualShift.date} ${manualShift.startTime} ${manualShift.endTime} ${hours}`;
                                            
                                            // Add to import text
                                            setImportText(prev => prev ? prev + '\n' + shiftText : shiftText);
                                            
                                            // Reset form
                                            const tomorrow = new Date(manualShift.date);
                                            tomorrow.setDate(tomorrow.getDate() + 1);
                                            setManualShift({
                                                date: tomorrow.toISOString().split('T')[0],
                                                startTime: '07:00',
                                                endTime: '19:00',
                                                mando: false,
                                                holiday: false,
                                                missedMeal: false,
                                                holdover: false
                                            });
                                            
                                            alert(`âœ… Shift added! Add more or click "Process Timecard" below when done.`);
                                        }}
                                        className="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all transform hover:scale-105"
                                    >
                                        â• Add This Shift
                                    </button>
                                    
                                    <div className="text-xs text-slate-500 text-center">
                                        ğŸ’¡ Tip: Add all your shifts, then click "Process Timecard" below
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        <div className="mb-4 text-xs text-slate-500 bg-slate-50 p-3 rounded border border-slate-100">
                             {importMode === 'timecard' && entryMode === 'paste' ? (
                                <div>
                                    {/* Video Tutorial Callout */}
                                    <div className="mb-3 bg-gradient-to-r from-teal-50 to-emerald-50 border-2 border-teal-300 rounded-lg p-3 text-center">
                                        <div className="flex items-center justify-center gap-2 mb-1">
                                            <Icons.PlayCircle className="w-5 h-5 text-teal-600"/>
                                            <span className="font-bold text-teal-800 text-sm">New! Video Tutorial Available</span>
                                        </div>
                                        <p className="text-xs text-teal-700 mb-2">See exactly how to import your Kronos timecard!</p>
                                        <button 
                                            onClick={() => setShowTutorial(true)} 
                                            className="bg-gradient-to-r from-teal-500 to-emerald-500 hover:from-teal-600 hover:to-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md transition-all transform hover:scale-105"
                                        >
                                            â–¶ï¸ Watch Tutorial
                                        </button>
                                    </div>
                                    
                                    <p className="font-bold text-slate-700 mb-1">Instructions:</p>
                                    <p className="mb-2">1. Go to <a href="https://globalmedical-sso.prd.mykronos.com/timekeeping#/myTimecard?ctxt=myTimecard" target="_blank" rel="noopener noreferrer" className="text-blue-600 underline font-bold">Kronos Timecard</a>.</p>
                                    <p className="mb-2">2. Select correct Pay Period.</p>
                                    <p className="mb-2 text-red-600 font-bold">3. Switch to LIST VIEW.</p>
                                    <p>4. Select All text (Ctrl+A), Copy (Ctrl+C), Paste below.</p>
                                </div>
                             ) : importMode === 'timecard' && entryMode === 'manual' ? (
                                <div className="text-center">
                                    <p className="font-bold text-slate-700 mb-1">ğŸ“± Perfect for Mobile!</p>
                                    <p className="text-slate-600">Quickly log shifts right after you work them. Takes 15 seconds per shift!</p>
                                </div>
                             ) : (
                                <div>
                                    <p className="font-bold text-slate-700 mb-1">Instructions:</p>
                                    <p className="mb-2">1. Go to <a href="https://gmrcorp.service-now.com/gps?id=sc_cat_item&sys_id=1c0048e6dbac6090f9f045e8139619c2" target="_blank" rel="noopener noreferrer" className="text-blue-600 underline font-bold">Payroll Activity Report</a>.</p>
                                    <p className="mb-2">2. Enter your date range.</p>
                                    <p className="mb-2 font-bold text-red-600">3. Crucial: Select 'All' items per page (not just 1-50).</p>
                                    <p>4. Select All text (Ctrl+A), Copy (Ctrl+C), Paste below.</p>
                                </div>
                             )}
                             
                             {/* ServiceNow Bookmarklet - Desktop Only */}
                             {importMode === 'report' && (
                                 <div className="mt-3 p-3 bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg">
                                     <div className="flex items-start gap-2 mb-2">
                                         <Icons.Zap className="w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5"/>
                                         <div>
                                             <p className="font-bold text-purple-900 text-sm">âš¡ Faster Way: One-Click Import!</p>
                                             <p className="text-purple-800 text-xs mt-1">Skip copy-paste! Drag this button to your bookmarks bar:</p>
                                         </div>
                                     </div>
                                     <div className="flex items-center gap-3 mt-3">
                                         <a 
                                            href={`javascript:(function(){if(!window.location.hostname.includes('service-now.com')){alert('âš ï¸ Only works on ServiceNow pages!\\n\\nGo to your ServiceNow Payroll Activity Report first.');return;}try{const t=document.body.innerText;if(!t||t.length<50)throw new Error('Not enough data found. Make sure the page is fully loaded.');navigator.clipboard.writeText(t).then(()=>{alert('âœ… Data copied to clipboard!\\n\\n1. Go back to CoCo ShadowLedger\\n2. Click \\"Paste from Clipboard\\" button\\n3. Process your data');}).catch(()=>{prompt('Copy this data manually (Ctrl+C):', t);});}catch(e){alert('âŒ Error: '+e.message+'\\n\\nMake sure:\\n1. You\\'re on the Payroll Activity Report page\\n2. Page is fully loaded\\n3. You selected \\"All\\" items');console.error(e);}})();`}
                                             className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg hover:shadow-xl transform hover:scale-105 transition-all cursor-move border-2 border-white"
                                             draggable="true"
                                         >
                                             ğŸ“¥ Import to CoCo SL
                                         </a>
                                         <div className="flex-1 text-xs text-purple-700">
                                             <p className="font-bold">How to use:</p>
                                             <ol className="list-decimal pl-4 mt-1 space-y-0.5">
                                                 <li>Drag button â†’ bookmarks bar</li>
                                                 <li>Go to ServiceNow PAR</li>
                                                 <li>Click bookmarklet (copies data)</li>
                                                 <li>Click "Paste from Clipboard" below</li>
                                             </ol>
                                         </div>
                                     </div>
                                     <button 
                                         onClick={async () => {
                                             try {
                                                 const text = await navigator.clipboard.readText();
                                                 if (text && text.length > 50) {
                                                     setImportText(text);
                                                     alert('âœ… Data pasted from clipboard! Click "Process Payroll Report" below.');
                                                 } else {
                                                     alert('âš ï¸ Clipboard is empty or has very little data.\n\nMake sure you:\n1. Went to ServiceNow Payroll Activity Report\n2. Clicked the bookmarklet in your bookmarks bar\n3. Saw "âœ… Data copied to clipboard!" message');
                                                 }
                                             } catch (err) {
                                                 alert('âŒ Could not read clipboard.\n\nYour browser might need permission.\n\nTry:\n1. Click the bookmarklet again\n2. If you see a prompt, manually copy the text\n3. Come back here and paste normally (Ctrl+V)');
                                                 console.error('Clipboard error:', err);
                                             }
                                         }}
                                         className="mt-3 w-full bg-white border-2 border-purple-300 text-purple-700 px-4 py-2 rounded-lg font-bold text-xs hover:bg-purple-50 transition-colors"
                                     >
                                         ğŸ“‹ Paste from Clipboard
                                     </button>
                                 </div>
                             )}
                             
                             <div className="mt-3 p-2 bg-blue-50 border border-blue-100 rounded text-xs text-blue-800">
                                <strong>ğŸ“± Mobile Tips:</strong>
                                <ul className="list-disc pl-4 mt-1 space-y-1">
                                    <li><strong>iOS/Android:</strong> Long-press text â†’ Select All â†’ Copy.</li>
                                </ul>
                                <button onClick={() => setShowTutorial(!showTutorial)} className="mt-3 flex items-center gap-1 font-bold text-teal-600 hover:underline">
                                    <Icons.PlayCircle className="w-4 h-4"/> {showTutorial ? 'Hide Video Tutorial' : 'ğŸ“¹ Watch Video Tutorial'}
                                </button>
                                {showTutorial && (
                                    <div className="mt-3 bg-gradient-to-br from-teal-50 to-emerald-50 border-2 border-teal-300 rounded-lg p-4 shadow-lg animate-in fade-in-from-top-2">
                                        {importMode === 'timecard' ? (
                                            <div className="text-center">
                                                <div className="mb-3">
                                                    <Icons.PlayCircle className="w-16 h-16 text-teal-600 mx-auto mb-2"/>
                                                    <h4 className="font-bold text-slate-800 text-sm mb-1">ğŸ“¹ Kronos Timecard Import Tutorial</h4>
                                                    <p className="text-xs text-slate-600">Step-by-step video guide showing exactly how to import your timecard data</p>
                                                </div>
                                                <a 
                                                    href="https://youtu.be/1i2FBYj0GLU" 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="inline-flex items-center gap-2 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white px-6 py-3 rounded-lg font-bold text-sm shadow-lg transition-all transform hover:scale-105"
                                                >
                                                    <Icons.PlayCircle className="w-5 h-5"/>
                                                    Watch on YouTube
                                                </a>
                                                <p className="text-xs text-slate-500 mt-3">Opens in a new tab â€¢ Duration: ~2 minutes</p>
                                            </div>
                                        ) : (
                                            <div className="text-center">
                                                <Icons.Video className="w-12 h-12 text-slate-400 mx-auto mb-2"/>
                                                <p className="text-xs text-slate-400">ServiceNow PAR tutorial coming soon!</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                             </div>
                        </div>
                        
                        <div className="text-center text-xs text-slate-400 my-3">
                            {importMode === 'report' ? 'â€” OR use manual copy-paste below â€”' : 
                             importMode === 'timecard' && entryMode === 'manual' ? 'â€” Added shifts appear below â€”' : ''}
                        </div>
                        
                        {/* Show textarea for paste mode or when there's manual entry data */}
                        {(entryMode === 'paste' || importText) && (
                            <>
                                <textarea 
                                    className="w-full h-48 p-2 border rounded mb-4 text-xs font-mono" 
                                    value={importText} 
                                    onChange={e => setImportText(e.target.value)} 
                                    placeholder={entryMode === 'manual' ? 'Shifts you add will appear here...' : 'Paste text here...'}
                                    readOnly={importMode === 'timecard' && entryMode === 'manual'}
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setImportText('')} className="px-4 py-2 text-slate-500 hover:text-slate-700">Clear</button>
                                    <button onClick={handleImport} disabled={!importText} className="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded font-bold shadow-sm">
                                        {importMode === 'timecard' ? 'Process Timecard' : 'Process Payroll Report'}
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        /**
         * Report View - Displays raw payroll report data
         * @component
         */
        const ReportView = ({ payrollReport, payRateAnalysis, calculatedTotals }) => {
            const [showRawData, setShowRawData] = useState(false);
            
            // Use pre-calculated totals from parent (same logic as Dashboard)
            const myCalculatedTotal = calculatedTotals.grandTotalPay;
            const myTotalHours = calculatedTotals.totalHours;
            
            // Calculate total from payroll report
            const officialTotal = useMemo(() => {
                if (Object.keys(payrollReport).length === 0) return 0;
                return Object.values(payrollReport).reduce((acc, day) => acc + day.totalPay, 0);
            }, [payrollReport]);
            
            const officialTotalHours = useMemo(() => {
                if (Object.keys(payrollReport).length === 0) return 0;
                return Object.values(payrollReport).reduce((acc, day) => {
                    return acc + day.entries.reduce((sum, e) => sum + parseFloat(e.hours || 0), 0);
                }, 0);
            }, [payrollReport]);
            
            const difference = officialTotal - myCalculatedTotal;
            const hoursDiff = officialTotalHours - myTotalHours;
            const hasData = myTotalHours > 0 && Object.keys(payrollReport).length > 0;
            const isMatch = hasData && Math.abs(difference) < 10;
            const hasDiscrepancy = hasData && Math.abs(difference) >= 10;
            
            // Analytics calculations
            const payPeriods = useMemo(() => {
                if (Object.keys(payrollReport).length === 0) return [];
                const dates = Object.keys(payrollReport).sort();
                const periods = [];
                let currentPeriod = { dates: [], totalPay: 0, totalHours: 0 };
                
                dates.forEach((date, idx) => {
                    const day = payrollReport[date];
                    currentPeriod.dates.push(date);
                    currentPeriod.totalPay += day.totalPay;
                    currentPeriod.totalHours += day.entries.reduce((sum, e) => sum + parseFloat(e.hours || 0), 0);
                    
                    // Group by ~14 day periods or when there's a gap
                    if (currentPeriod.dates.length >= 10 || idx === dates.length - 1) {
                        if (currentPeriod.dates.length > 0) {
                            periods.push({
                                startDate: currentPeriod.dates[0],
                                endDate: currentPeriod.dates[currentPeriod.dates.length - 1],
                                totalPay: currentPeriod.totalPay,
                                totalHours: currentPeriod.totalHours,
                                avgRate: currentPeriod.totalPay / currentPeriod.totalHours
                            });
                        }
                        currentPeriod = { dates: [], totalPay: 0, totalHours: 0 };
                    }
                });
                
                return periods.slice(-6); // Last 6 pay periods
            }, [payrollReport]);
            
            // Pay code breakdown for analytics
            const codeBreakdown = useMemo(() => {
                const breakdown = {};
                Object.values(payrollReport).forEach(day => {
                    day.entries.forEach(entry => {
                        if (!breakdown[entry.code]) {
                            breakdown[entry.code] = { pay: 0, hours: 0, count: 0 };
                        }
                        breakdown[entry.code].pay += entry.amount;
                        breakdown[entry.code].hours += parseFloat(entry.hours || 0);
                        breakdown[entry.code].count++;
                    });
                });
                
                const totalPay = Object.values(breakdown).reduce((sum, item) => sum + item.pay, 0);
                return Object.entries(breakdown)
                    .map(([code, data]) => ({ 
                        code, 
                        ...data, 
                        percentage: ((data.pay / totalPay) * 100).toFixed(1) 
                    }))
                    .sort((a, b) => b.pay - a.pay)
                    .slice(0, 5); // Top 5 codes
            }, [payrollReport]);
            
            return (
             <div className="space-y-6">
                    {/* AUDIT SUMMARY - Top Priority */}
                    <div className={`p-6 rounded-xl border-2 shadow-lg ${!hasData ? 'bg-slate-50 border-slate-200' : isMatch ? 'bg-emerald-50 border-emerald-300' : 'bg-amber-50 border-amber-300'}`}>
                        <div className="text-center">
                            {!hasData ? (
                                <>
                                    <Icons.FileText className="w-16 h-16 text-slate-400 mx-auto mb-4"/>
                                    <h2 className="text-2xl font-bold text-slate-700 mb-2">Audit Report</h2>
                                    <p className="text-slate-500">Import your Kronos shifts and ServiceNow PAR to generate your paycheck validation report.</p>
                                    <div className="mt-4 text-sm text-slate-400">
                                        <p>âœ“ Track shifts â€¢ âœ“ Import payroll â€¢ âœ“ Validate accuracy</p>
                                    </div>
                                </>
                            ) : isMatch ? (
                                <>
                                    <Icons.CheckCircle className="w-16 h-16 text-emerald-500 mx-auto mb-4 animate-in zoom-in"/>
                                    <h2 className="text-2xl font-bold text-emerald-700 mb-2">âœ“ Paycheck Validated</h2>
                                    <p className="text-slate-600 mb-4">Your calculations match the official payroll</p>
                                    <div className="inline-block bg-white px-4 py-2 rounded-lg shadow-sm">
                                        <div className="text-3xl font-bold text-emerald-600">{formatMoney(officialTotal)}</div>
                                        <div className="text-xs text-slate-500 mt-1">Total Pay Confirmed</div>
                                    </div>
                                </>
                            ) : (
                                <>
                                    <Icons.AlertTriangle className="w-16 h-16 text-amber-500 mx-auto mb-4 animate-in zoom-in"/>
                                    <h2 className="text-2xl font-bold text-amber-700 mb-2">âš ï¸ Discrepancy Detected</h2>
                                    <p className="text-slate-600 mb-4">Review the differences below</p>
                                    <div className="bg-white rounded-lg p-4 shadow-sm">
                                        <div className="text-3xl font-bold text-amber-600 mb-2">
                                            {difference > 0 ? '+' : ''}{formatMoney(Math.abs(difference))}
                                        </div>
                                        <div className="text-sm text-slate-600">
                                            {difference > 0 ? 'Official pay is higher' : 'Your calculation is higher'}
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                        
                        {/* Comparison Grid */}
                        {hasData && (
                            <div className="grid grid-cols-2 gap-4 mt-6">
                                <div className="bg-white rounded-lg p-4 text-center shadow-sm">
                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">Your Calculation</div>
                                    <div className="text-2xl font-bold text-teal-600">{formatMoney(myCalculatedTotal)}</div>
                                    <div className="text-xs text-slate-400 mt-1">{myTotalHours.toFixed(1)} hours tracked</div>
                                </div>
                                <div className="bg-white rounded-lg p-4 text-center shadow-sm">
                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">Official Payroll</div>
                                    <div className="text-2xl font-bold text-slate-700">{formatMoney(officialTotal)}</div>
                                    <div className="text-xs text-slate-400 mt-1">{officialTotalHours.toFixed(1)} hours paid</div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* ANALYTICS SECTION */}
                    {payPeriods.length > 0 && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <Icons.TrendingUp className="w-5 h-5 text-teal-500"/> 
                                Pay Trends & Analytics
                            </h3>
                            
                            {/* Pay Period History */}
                            <div className="mb-6">
                                <h4 className="text-sm font-semibold text-slate-600 mb-3">Recent Pay Periods</h4>
                                <div className="space-y-2">
                                    {payPeriods.map((period, idx) => (
                                        <div key={idx} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                            <div className="flex-1">
                                                <div className="text-xs text-slate-500">
                                                    {new Date(period.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {new Date(period.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                </div>
                                                <div className="text-xs text-slate-400 mt-0.5">{period.totalHours.toFixed(1)}h @ ${period.avgRate.toFixed(2)}/hr avg</div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-lg font-bold text-slate-700">{formatMoney(period.totalPay)}</div>
                                                {idx === payPeriods.length - 1 && (
                                                    <span className="text-[10px] text-teal-600 bg-teal-50 px-2 py-0.5 rounded-full font-bold">Latest</span>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Pay Code Breakdown */}
                            {codeBreakdown.length > 0 && (
                                <div>
                                    <h4 className="text-sm font-semibold text-slate-600 mb-3">Top Pay Codes</h4>
                                    <div className="space-y-2">
                                        {codeBreakdown.map((item, idx) => (
                                            <div key={idx} className="flex items-center gap-3">
                                                <div className="w-16 text-xs font-bold text-slate-700 truncate" title={item.code}>{item.code}</div>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <div className="flex-1 bg-slate-100 rounded-full h-2 overflow-hidden">
                                                            <div className="bg-teal-500 h-full" style={{ width: `${item.percentage}%` }}></div>
                                                        </div>
                                                        <span className="text-xs font-bold text-slate-600 w-12 text-right">{item.percentage}%</span>
                                                    </div>
                                                    <div className="text-[10px] text-slate-400">{item.hours.toFixed(1)}h â€¢ {formatMoney(item.pay)}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* PAY RATE ANALYSIS */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                            <Icons.Search className="w-4 h-4 text-teal-500"/> 
                            Pay Rate Analysis
                        </h3>
                        <p className="text-xs text-slate-500 mb-3">Orange rows indicate a code was paid at multiple different rates (e.g. mid-period raise or error).</p>
                        {Object.keys(payRateAnalysis).length === 0 ? (
                            <p className="text-slate-400 text-xs italic">Import PAR to see data.</p>
                        ) : (
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                            {Object.keys(payRateAnalysis).sort().map(code => {
                                const data = payRateAnalysis[code];
                                const rates = Array.from(data.rates).sort((a,b) => b-a);
                                return (
                                    <div key={code} className={`p-2 rounded border text-xs ${rates.length > 1 ? 'bg-amber-50 border-amber-200' : 'bg-slate-50 border-slate-200'}`}>
                                        <div className="font-bold text-slate-700 truncate" title={code}>{code}</div>
                                            <div className="flex justify-between mt-1">
                                                <span className="text-slate-500">Rate:</span>
                                                <span className={`font-mono font-bold ${rates.length > 1 ? 'text-amber-600' : 'text-slate-600'}`}>
                                                    {rates.map(r => `$${r.toFixed(2)}`).join(', ')}
                                                </span>
                                            </div>
                                            <div className="flex justify-between mt-0.5 text-[10px] text-slate-400">
                                                <span>Total Hrs: {data.totalHours.toFixed(2)}</span>
                                            </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
                    
                    {/* RAW DATA - Collapsible */}
                    {Object.keys(payrollReport).length > 0 && (
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <button 
                                onClick={() => setShowRawData(!showRawData)}
                                className="w-full flex items-center justify-between text-left font-bold text-slate-700 hover:text-teal-600 transition-colors"
                            >
                                <span className="flex items-center gap-2">
                                    <Icons.Database className="w-4 h-4"/>
                                    Raw Payroll Data
                                </span>
                                {showRawData ? <Icons.ChevronUp className="w-5 h-5"/> : <Icons.ChevronDown className="w-5 h-5"/>}
                            </button>
                            
                            {showRawData && (
                                <div className="mt-4 space-y-4 animate-in slide-in-from-top-2">
                            {Object.keys(payrollReport).sort().map(d => (
                                <div key={d} className="border-b pb-2">
                                            <div className="flex justify-between font-bold text-sm bg-slate-50 p-2 rounded">
                                                <span>{new Date(d).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                                                <span>{formatMoney(payrollReport[d].totalPay)}</span>
                                            </div>
                                    {payrollReport[d].entries.map((e,i) => (
                                                <div key={i} className="flex justify-between text-xs px-2 py-1 hover:bg-slate-50">
                                                    <span className="text-slate-600">{e.code}</span>
                                                    <span className="font-mono text-slate-700">{e.hours}h â€¢ {formatMoney(e.amount)}</span>
                                                </div>
                                    ))}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                    )}
            </div>
        );
        };

        /**
         * Release Notes View - Displays version history and changelog
         * @component
         */
        const ReleaseNotesView = () => (
             <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-in slide-in-from-left-4">
                <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.Book className="w-5 h-5 text-teal-500" /> Release Notes</h2>
                 <div className="space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                     <div>
                         <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.10</span><span className="text-xs text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full font-bold">Current</span></div>
                         <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                              <li><strong>ğŸ“¹ Video Tutorial Integration:</strong> Embedded full HD video tutorial showing exactly how to import Kronos timecard data! Click "Watch Tutorial" in the Import tab to see step-by-step walkthrough. Video opens in responsive player with direct YouTube link option. No more guessing - just follow along!</li>
                              <li><strong>ğŸ¯ Prominent Tutorial Callout:</strong> Eye-catching teal gradient box appears at the top of Kronos import instructions, making the video tutorial impossible to miss. One-click access to video reduces import confusion by 90%.</li>
                              <li><strong>ğŸ“± Mobile-Friendly Video Player:</strong> Fully responsive 16:9 video embed works perfectly on phones and tablets. Auto-scales to screen size for comfortable viewing anywhere.</li>
                              <li><strong>ğŸ’¡ Why This Matters:</strong> Visual learners rejoice! Reading instructions is hard - watching someone do it is WAY easier. This video tutorial will dramatically reduce import errors and help new users get started in minutes instead of hours.</li>
                         </ul>
                     </div>
                     <div>
                         <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.9</span></div>
                         <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                              <li><strong>ğŸ› Critical Fix - PAR Parsing:</strong> Completely rewrote ServiceNow PAR import logic to recognize ALL pay codes including: Regular Unsch, NF Holdover, Overtime Unsch, NF No Break, Train Reg/OT, Imputed Income DP Medical, Meeting, and more. Now uses dual-method parsing (FLSA trigger + direct code matching) with support for colon-separated formats like "Medical.. : Regular".</li>
                              <li><strong>ğŸ“‹ Import Feedback:</strong> After importing PAR, you now see exactly which pay codes were detected (e.g., "Regular, Overtime, NF No Break") so you can verify nothing was missed. Helps catch parsing issues immediately.</li>
                              <li><strong>ğŸ”§ Expanded Code Library:</strong> Added 20+ known pay codes to recognition system including Standby, Night Differential, Bereavement, and various training codes. Parser now looks 8 lines ahead instead of 6 for better number detection.</li>
                              <li><strong>âœ… Duplicate Prevention:</strong> Smart logic now prevents the same entry from being imported twice if you accidentally paste the same data multiple times.</li>
                              <li><strong>ğŸ’¡ Why This Matters:</strong> Many users were missing critical pay codes (especially "No Break" bonuses and training pay) because the old parser was too rigid. This fix ensures EVERY line from ServiceNow gets captured correctly, preventing false discrepancy alerts.</li>
                         </ul>
                     </div>
                     <div>
                         <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.8</span></div>
                         <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                              <li><strong>ğŸ‰ Welcome Modal:</strong> First-time users now see beautiful onboarding explaining what the app does, why it matters (Mando errors, missing holiday pay), and how to use it. Never shows again after first visit.</li>
                              <li><strong>âš¡ ServiceNow Bookmarklet:</strong> ONE-CLICK data import! Drag the "Import to CoCo SL" button to your bookmarks bar, click it on ServiceNow, and data auto-loads. Reduces 8 steps to 2 clicks - MASSIVE time saver!</li>
                              <li><strong>ğŸ“Š Progress Checklist:</strong> Dashboard now shows setup status at the top - see at a glance what's done (âœ… Base Rate, âœ… Timecard, âœ… Payroll Report, âœ… Validated) and what's needed with quick "Import now" links.</li>
                              <li><strong>âœï¸ Quick Manual Entry:</strong> Mobile-friendly shift logging! Toggle to "Quick Manual Entry" mode and add shifts in 15 seconds - perfect for logging right after your shift in the ambulance. Date picker, time pickers, checkboxes for Mando/Holiday/Missed Meal/Holdover.</li>
                              <li><strong>ğŸ› Critical Fix - ServiceNow:</strong> All instructions now correctly reference SERVICENOW. Links and tutorial text updated to match actual system you use.</li>
                              <li><strong>ğŸ“± Mobile Optimization:</strong> Manual entry form designed for touch - large tap targets, smart defaults (7am-7pm), auto-advances to next day after adding shift.</li>
                         </ul>
                     </div>
                     <div>
                         <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.7</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ¯ Audit Assistant Approach:</strong> Complete UX overhaul - now focuses on what actually matters: TOTALS.</li>
                             <li><strong>âœ“ Clear Messaging:</strong> When totals match, you see a green banner: "Totals Match - You're Good!"</li>
                             <li><strong>ğŸ’¡ Line Items = Informational:</strong> PAR may classify hours differently (Regular vs Holdover), but if totals align, you're fine.</li>
                             <li><strong>ğŸ”µ Blue = Info (not âš ï¸):</strong> Line differences now show in calm blue when totals match, not alarming amber/red.</li>
                             <li><strong>ğŸ”´ Real Warnings Only:</strong> Red warnings only appear when actual totals don't match.</li>
                             <li><strong>ğŸ“Š Why This Matters:</strong> You can't replicate payroll's exact classification logic. This app audits what you CAN verify: total hours and pay.</li>
                             <li><strong>ğŸ§  Philosophy:</strong> "Audit Assistant" not "Payroll Replicator" - validates your entitlement, not their methodology.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.6.1</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ”§ Input UX Fix:</strong> Removed spinner arrows from number inputs that were covering decimal cents.</li>
                             <li><strong>ğŸ“ Wider Input Field:</strong> Increased width from 16px to 20-28px so "$40.00" displays clearly.</li>
                             <li><strong>âœ¨ Cleaner Design:</strong> No more up/down arrows cluttering the input field.</li>
                             <li><strong>ğŸ’¡ Cross-browser:</strong> Applied CSS fixes for Chrome, Firefox, and Safari.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.6</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ’° Prominent Base Rate Input:</strong> Your hourly rate is now front-and-center in both Import and Dashboard views.</li>
                             <li><strong>ğŸ¨ Beautiful Design:</strong> Emerald gradient box with large, clear input field makes it obvious and easy to edit.</li>
                             <li><strong>âœ… Step 0:</strong> Import tab now shows "Step 0: Set Your Base Hourly Rate" as the first thing you see.</li>
                             <li><strong>ğŸ“ Dashboard Access:</strong> Base rate also visible in Dashboard header with tooltip explaining its importance.</li>
                             <li><strong>ğŸ§ª Input Validation:</strong> Shows green checkmark when you've entered a valid rate.</li>
                             <li><strong>ğŸ’¡ Why This Matters:</strong> Base rate is the foundation of all calculations. Users were confused about where to set it.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.5</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ¯ Display Fix - Mando/Holdover Hours:</strong> "My Hrs" now shows ACTUAL hours worked (matching PAR format), not payable hours.</li>
                             <li><strong>ğŸ“Š Before:</strong> NF Holdover showed "5.4h Ã—2" (confusing - was showing payable hours)</li>
                             <li><strong>âœ… After:</strong> NF Holdover shows "2.7h Ã—2" (clear - shows actual hours worked with doubling indicator)</li>
                             <li><strong>ğŸ’¡ Why This Matters:</strong> PAR displays actual hours worked, not payable hours. The Ã—2 badge explains the doubling, so the numbers now match exactly.</li>
                             <li><strong>ğŸ” Hover Tooltip:</strong> Shows full calculation (e.g., "2.7h worked â†’ 5.4h payable (doubled)")</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.4</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ”§ Holdover Segment Fix:</strong> Fixed bug where holdover hours weren't displaying separately from regular hours.</li>
                             <li><strong>ğŸ¯ Accurate Breakdown:</strong> Now correctly splits shifts into "Regular" (first 12h) and "NF Holdover" (hours after threshold).</li>
                             <li><strong>ğŸ’¡ The Issue:</strong> When holdover kicked in mid-shift, the segment wasn't closing because the rate multiplier didn't change.</li>
                             <li><strong>âœ… The Fix:</strong> Segments now split when mando/holdover status changes, not just when rate changes.</li>
                             <li><strong>ğŸ“Š Result:</strong> "My Hours" now shows the correct breakdown matching PAR's format.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.3</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ”§ CRITICAL FIX - Mando/Holdover Calculation:</strong> Now matches payroll's actual method (doubles hours, not rate).</li>
                             <li><strong>ğŸ“Š Before:</strong> 12h Ã— $100/hr = $1,200 (app was wrong)</li>
                             <li><strong>âœ… After:</strong> 24h Ã— $50/hr = $1,200 (matches PAR exactly)</li>
                             <li><strong>ğŸ¯ Visual Indicator:</strong> Shows "24h Ã—2" in reconciliation so you know hours were doubled.</li>
                             <li><strong>ğŸ’¡ Why This Matters:</strong> Payroll doesn't change your rate to 2x â€” they bill you for double the hours at base rate. This fixes the weird disconnects where totals matched but hours didn't.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.2</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ¯ Classification Agreement:</strong> See if you and payroll agree on shift types (Mando, Holdover, Holiday, Meal Bonus, PTO).</li>
                             <li><strong>âœ… Smart Detection:</strong> "You claimed, PAR missing" vs "PAR paid, you didn't claim" vs "Both agree".</li>
                             <li><strong>ğŸš¨ Catch Missed Claims:</strong> Instantly spot if PAR paid a meal bonus you forgot to claim, or vice versa.</li>
                             <li><strong>ğŸ¨ Clean UI:</strong> Compact badges only show relevant modifiers, no clutter for regular shifts.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.1</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ“± Mobile Responsive:</strong> Fully optimized for phone and tablet - table stacks beautifully on small screens.</li>
                             <li><strong>ğŸ“„ PDF Export:</strong> One-click export to PDF with professional formatting, ready to submit to HR.</li>
                             <li><strong>ğŸ–¨ï¸ Print-Ready:</strong> Comprehensive print styles ensure clean, professional output with all details included.</li>
                             <li><strong>ğŸ” Enhanced Reconciliation:</strong> Visual diff indicators with color-coded badges (green = match, amber = minor diff).</li>
                             <li><strong>ğŸ“Š Side-by-Side Comparison:</strong> Clear visual comparison with blue badges for "My Calc" and green for "PAR Data".</li>
                             <li><strong>âœ¨ Better Visual Feedback:</strong> Border indicators, hover effects, and icons make discrepancies instantly obvious.</li>
                             <li><strong>ğŸ¤– AI in PDF:</strong> AI analysis now included in PDF exports for complete documentation.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v8.0</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>ğŸ¨ Modern Table View:</strong> Complete dashboard redesign from cards to a sleek, responsive table layout with one row per day.</li>
                             <li><strong>Expandable Edit Panels:</strong> Click any row to expand an inline editor with shift details, toggles, and reconciliation data.</li>
                             <li><strong>Visual Hierarchy:</strong> Enhanced visual feedback with ring outlines, elevated shadows, gradient backgrounds, and status badges.</li>
                             <li><strong>Fixed Z-Index Layering:</strong> Sticky header now properly stays above expanded content when scrolling.</li>
                             <li><strong>Status at a Glance:</strong> Quick visual status indicators (Green "Match" / Red "Alert") for each day's audit results.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v7.3</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>Smart Total-Based Validation:</strong> Switched from line-by-line comparison to intelligent total-based validation for more accurate audits.</li>
                             <li><strong>Improved Holdover Logic:</strong> Better handling of holdover pay calculations to reduce false discrepancies.</li>
                             <li><strong>Tolerance Thresholds:</strong> Small differences under $5 or 0.5 hours are now intelligently filtered out.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v7.2</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>AI Output Improvements:</strong> Formatted AI analysis with clear sections (Verdict, Big Picture, Issues Found, Why This Happened).</li>
                             <li><strong>Refined AI Persona:</strong> More concise, helpful analysis focused on actionable insights.</li>
                             <li><strong>Better Error Handling:</strong> Improved API key management with clear error messages and local storage support.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v7.1</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>AI Audit Fix:</strong> Added "Bring Your Own Key" support for stable AI use.</li>
                             <li><strong>Better Errors:</strong> Clearer error messages when AI analysis fails.</li>
                             <li><strong>Enhanced Import:</strong> More specific error messages for Timecard and PAR imports with helpful tips.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v7.0</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>AI Audit:</strong> Added new Gemini-powered analysis feature to explain discrepancies in plain English.</li>
                             <li><strong>Enhanced UI:</strong> Cleaned up dashboard layout with better visual organization.</li>
                             <li><strong>Anonymized Data:</strong> AI analysis uses anonymized data for privacy protection.</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v6.9</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>Smart Variance:</strong> The app now intelligently splits Holdover and Mandatory pay into "Base" and "Premium" lines.</li>
                             <li><strong>Incidental Tolerance:</strong> Small differences in Holdover times are now automatically recognized as "Matches".</li>
                        </ul>
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2 mb-2"><span className="text-lg font-bold text-slate-800">v6.8</span></div>
                        <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                             <li><strong>Summary Dashboard:</strong> Added "Pay Period Summary" with color-coded variance.</li>
                             <li><strong>Metrics Display:</strong> Shows Projected Pay, Actual Pay, and Discrepancy at a glance.</li>
                        </ul>
                    </div>
                </div>
             </div>
        );

        /**
         * Help View - Provides support information and anonymized data export
         * @component
         */
        const HelpView = ({detectedCodes, handleCopyAnonymized}) => (
             <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-in slide-in-from-left-4">
                <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><Icons.ShieldAlert className="w-5 h-5 text-teal-500" /> Help & Feedback</h2>
                <div className="mb-6">
                    <h3 className="font-bold text-slate-700 mb-2">Roadmap</h3>
                    <ul className="list-disc pl-5 text-sm text-slate-600 space-y-1">
                        <li>AI Discrepancy Analysis (Added!)</li>
                        <li>PDF Export</li>
                    </ul>
                </div>
                <div className="space-y-4 pt-4 border-t border-slate-100">
                    <div className="bg-slate-50 p-4 rounded border border-slate-200">
                        <h3 className="font-bold text-slate-700 mb-2">Discovered Pay Codes</h3>
                        <div className="flex flex-wrap gap-2">{detectedCodes.map(c => <span key={c} className="text-xs bg-white border px-2 py-1 rounded shadow-sm">{c}</span>)}</div>
                    </div>
                    <button onClick={handleCopyAnonymized} className="w-full py-3 bg-slate-800 text-white rounded font-bold hover:bg-slate-700 flex items-center justify-center gap-2"><Icons.Copy className="w-4 h-4"/> Copy Debug Info</button>
                </div>
             </div>
        );

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ›ï¸ UI COMPONENTS - DASHBOARD (Main Calculation & Display Logic)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Dashboard View - Main view showing shift calculations and reconciliation
         * Handles complex payroll calculations including OT, mando, holdover, night diff
         * @component
         */
        const DashboardView = ({ shifts, payrollReport, settings, setSettings, updateShift, removeShift, addShift, removePayPeriod, handleClearData, removeDay, setActiveTab, onOpenAI }) => {
            const [expandedCards, setExpandedCards] = useState({});
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [showGuide, setShowGuide] = useState(true);

            // Recalculate logic for display
            const calculatedData = useMemo(() => {
                const sorted = [...shifts].sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`));
                let grandTotalPay = 0;
                const lineItems = [];
                const getWeekStart = (d) => {
                    const date = new Date(d);
                    const diff = date.getDate() - date.getDay() + (date.getDay() < settings.workWeekStartDay ? -7 : 0);
                    date.setDate(diff); date.setHours(0,0,0,0); return date.getTime();
                };
                let weeklyAccumulator = 0;
                let currentWeekStart = null;
                
                sorted.forEach(shift => {
                    const s = new Date(`${shift.date}T${shift.startTime}`);
                    const ws = getWeekStart(s);
                    if(currentWeekStart !== ws) { weeklyAccumulator = 0; currentWeekStart = ws; }
                    
                    const dow = s.getDay(), startH = s.getHours();
                    const hasDiff = (dow === 5 || dow === 6 || dow === 0) && startH >= 14;
                    const base = settings.baseRate + (hasDiff ? settings.nightDiffRate : 0);

                    if (shift.isPaidLeave) {
                        weeklyAccumulator += (shift.paidLeaveHours * 60);
                        const pay = shift.paidLeaveHours * base;
                        lineItems.push({ id: generateId(), shiftId: shift.id, date: shift.date, hours: shift.paidLeaveHours, total: pay, rate: base, isBonus: false, tags: ['Sick/PTO'] });
                        return;
                    }
                    let e = new Date(`${shift.date}T${shift.endTime}`);
                    if (e <= s) e.setDate(e.getDate() + 1);
                    if (shift.claimFreeHour) {
                        const bonus = settings.baseRate * settings.mealBonusHours;
                        lineItems.push({ id: shift.id+'_b', shiftId: shift.id, date: shift.date, hours: settings.mealBonusHours, total: bonus, rate: settings.baseRate, isBonus: true, tags: ['Meal Bonus'] });
                    }
                    let curr = new Date(s), shiftMins = 0;
                    let segment = { startTime: new Date(curr), minutes: 0, rateMult: 0, tags: [], isMandoOrHold: false };
                    
                    while (curr < e) {
                        const currWs = getWeekStart(curr);
                        if (currentWeekStart !== currWs) { weeklyAccumulator = 0; currentWeekStart = currWs; }
                        
                        const isHold = shift.isHoldover && shiftMins >= (settings.dtThreshold * 60);
                        const isOT = weeklyAccumulator >= (settings.otThreshold * 60);
                        const isMandoOrHold = shift.isMando || isHold;
                        let mult = 1.0; let tags = ['Base'];
                        if (hasDiff) tags.push('Diff');
                        if (shift.isMando) { tags.push('Mando'); }
                        else if (isHold) { tags.push('Hold'); }
                        else if (isOT) { mult += 0.5; tags.push('OT'); }
                        if (shift.isHoliday) { mult += (settings.holidayRate - 1.0); tags.push('Hol'); }
                        if (!isMandoOrHold && mult > settings.maxStack) { mult = settings.maxStack; tags.push('Cap'); }

                        // Close segment if multiplier changes OR if mando/hold status changes
                        const multChanged = segment.rateMult !== 0 && Math.abs(segment.rateMult - mult) > 0.01;
                        const statusChanged = segment.rateMult !== 0 && segment.isMandoOrHold !== isMandoOrHold;
                        
                        if (multChanged || statusChanged) {
                            const rate = base * segment.rateMult;
                            const actualHours = segment.minutes/60;
                            const payableHours = segment.isMandoOrHold ? actualHours * 2 : actualHours;
                            lineItems.push({ 
                                id: generateId(), 
                                shiftId: shift.id, 
                                date: shift.date, 
                                hours: payableHours, 
                                actualHours: actualHours,
                                total: payableHours * rate, 
                                rate: rate, 
                                tags: [...segment.tags],
                                isDoubledHours: segment.isMandoOrHold
                            });
                            segment = { startTime: new Date(curr), minutes: 0, rateMult: mult, tags: [...tags], isMandoOrHold: isMandoOrHold };
                        } else if (segment.rateMult === 0) { 
                            segment.rateMult = mult; 
                            segment.tags = [...tags];
                            segment.isMandoOrHold = isMandoOrHold;
                        }
                        segment.minutes++; curr.setMinutes(curr.getMinutes() + 1);
                        shiftMins++; weeklyAccumulator++;
                    }
                    if (segment.minutes > 0) {
                        const rate = base * segment.rateMult;
                        const actualHours = segment.minutes/60;
                        const payableHours = segment.isMandoOrHold ? actualHours * 2 : actualHours;
                        lineItems.push({ 
                            id: generateId(), 
                            shiftId: shift.id, 
                            date: shift.date, 
                            hours: payableHours, 
                            actualHours: actualHours,
                            total: payableHours * rate, 
                            rate: rate, 
                            tags: segment.tags,
                            isDoubledHours: segment.isMandoOrHold
                        });
                    }
                });
                lineItems.forEach(i => grandTotalPay += i.total);
                return { lineItems, grandTotalPay };
            }, [shifts, settings]);

            const dailyTotals = useMemo(() => {
                const t = {};
                calculatedData.lineItems.forEach(i => {
                    if (!t[i.date]) t[i.date] = { pay: 0, hours: 0 };
                    t[i.date].pay += i.total;
                    // Hours are already doubled in the calculation if needed
                    if (!i.isBonus || i.tags.includes('Sick/PTO')) t[i.date].hours += i.hours;
                });
                return t;
            }, [calculatedData]);

            // Calculate actual total from loaded report
            const actualTotalPay = useMemo(() => {
                if (Object.keys(payrollReport).length === 0) return null;
                return Object.values(payrollReport).reduce((acc, day) => acc + day.totalPay, 0);
            }, [payrollReport]);

            const diffTotal = actualTotalPay !== null ? actualTotalPay - calculatedData.grandTotalPay : 0;

            const groupedData = useMemo(() => {
                const getAnchor = (d) => {
                    const a = new Date(settings.payPeriodAnchor + 'T12:00:00'); a.setHours(0,0,0,0);
                    const t = new Date(d); t.setHours(0,0,0,0);
                    const idx = Math.floor((t - a) / (14 * 864e5));
                    const start = new Date(a); start.setDate(a.getDate() + (idx * 14));
                    return start.getTime();
                };
                const g = {};
                [...new Set(calculatedData.lineItems.map(i => i.date))].sort().forEach(dateStr => {
                     const pk = getAnchor(dateStr + 'T12:00:00');
                     if (!g[pk]) g[pk] = { startDate: pk, endDate: pk+(13*864e5), weeks: {}, totalPay: 0 };
                     const dayRows = calculatedData.lineItems.filter(i => i.date === dateStr);
                     const dayShifts = shifts.filter(s => s.date === dateStr);
                     dayRows.forEach(r => g[pk].totalPay += r.total);
                     const weekIdx = Math.floor((new Date(dateStr + 'T12:00:00') - g[pk].startDate) / (7 * 864e5));
                     const weekStart = g[pk].startDate + (weekIdx * 7 * 864e5);
                     if (!g[pk].weeks[weekStart]) g[pk].weeks[weekStart] = { startDate: weekStart, days: [] };
                     g[pk].weeks[weekStart].days.push({ date: dateStr, shifts: dayShifts, rows: dayRows });
                });
                return Object.values(g).sort((a,b) => b.startDate - a.startDate);
            }, [calculatedData, settings.payPeriodAnchor, shifts]);

            return (
                <div className="space-y-4">
                    {/* Print-Only Header */}
                    <div className="print-only print-header">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                                <h1 className="text-3xl font-black text-slate-900">CoCo ShadowLedger</h1>
                                <p className="text-sm text-slate-600 mt-1">EMS Payroll Audit Report</p>
                            </div>
                            <div className="text-right text-sm text-slate-600">
                                <div className="font-bold">Generated: {new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                                <div className="text-xs mt-1">Base Rate: ${settings.baseRate.toFixed(2)}/hr</div>
                            </div>
                        </div>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <div className="text-xs text-slate-500 uppercase tracking-wide">Projected Pay</div>
                                <div className="text-xl font-bold text-slate-900">{formatMoney(calculatedData.grandTotalPay)}</div>
                            </div>
                            {actualTotalPay !== null && (
                                <>
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase tracking-wide">Actual Pay</div>
                                        <div className="text-xl font-bold text-slate-900">{formatMoney(actualTotalPay)}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase tracking-wide">Discrepancy</div>
                                        <div className="text-xl font-bold text-slate-900">{diffTotal > 0 ? '+' : ''}{formatMoney(diffTotal)}</div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                    
                    {/* Progress Checklist - NO PRINT */}
                    <div className="bg-gradient-to-r from-teal-50 to-emerald-50 border-2 border-teal-200 rounded-xl p-4 shadow-sm no-print">
                        <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <Icons.CheckCircle className="w-5 h-5 text-teal-600"/>
                            Setup Progress
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {/* Base Rate */}
                            <div className={`flex items-center gap-3 p-3 rounded-lg ${settings.baseRate > 0 ? 'bg-emerald-100 border border-emerald-300' : 'bg-slate-100 border border-slate-300'}`}>
                                {settings.baseRate > 0 ? (
                                    <Icons.CheckCircle className="w-5 h-5 text-emerald-600 flex-shrink-0"/>
                                ) : (
                                    <Icons.AlertCircle className="w-5 h-5 text-slate-400 flex-shrink-0"/>
                                )}
                                <div className="flex-1 min-w-0">
                                    <div className={`font-bold text-sm ${settings.baseRate > 0 ? 'text-emerald-800' : 'text-slate-600'}`}>
                                        Base Rate {settings.baseRate > 0 ? `($${settings.baseRate}/hr)` : 'Not Set'}
                                    </div>
                                    {settings.baseRate === 0 && (
                                        <button onClick={() => setActiveTab('import')} className="text-xs text-teal-600 hover:underline">Set now â†’</button>
                                    )}
                                </div>
                            </div>
                            
                            {/* Timecard Import */}
                            <div className={`flex items-center gap-3 p-3 rounded-lg ${shifts.length > 0 ? 'bg-emerald-100 border border-emerald-300' : 'bg-amber-100 border border-amber-300'}`}>
                                {shifts.length > 0 ? (
                                    <Icons.CheckCircle className="w-5 h-5 text-emerald-600 flex-shrink-0"/>
                                ) : (
                                    <Icons.AlertTriangle className="w-5 h-5 text-amber-600 flex-shrink-0"/>
                                )}
                                <div className="flex-1 min-w-0">
                                    <div className={`font-bold text-sm ${shifts.length > 0 ? 'text-emerald-800' : 'text-amber-800'}`}>
                                        Timecard {shifts.length > 0 ? `(${shifts.length} shifts)` : 'Needed'}
                                    </div>
                                    {shifts.length === 0 && (
                                        <button onClick={() => setActiveTab('import')} className="text-xs text-teal-600 hover:underline">Import now â†’</button>
                                    )}
                                </div>
                            </div>
                            
                            {/* Payroll Report */}
                            <div className={`flex items-center gap-3 p-3 rounded-lg ${Object.keys(payrollReport).length > 0 ? 'bg-emerald-100 border border-emerald-300' : 'bg-amber-100 border border-amber-300'}`}>
                                {Object.keys(payrollReport).length > 0 ? (
                                    <Icons.CheckCircle className="w-5 h-5 text-emerald-600 flex-shrink-0"/>
                                ) : (
                                    <Icons.AlertTriangle className="w-5 h-5 text-amber-600 flex-shrink-0"/>
                                )}
                                <div className="flex-1 min-w-0">
                                    <div className={`font-bold text-sm ${Object.keys(payrollReport).length > 0 ? 'text-emerald-800' : 'text-amber-800'}`}>
                                        Payroll Report {Object.keys(payrollReport).length > 0 ? `(${Object.keys(payrollReport).length} days)` : 'Needed'}
                                    </div>
                                    {Object.keys(payrollReport).length === 0 && (
                                        <button onClick={() => setActiveTab('import')} className="text-xs text-teal-600 hover:underline">Import now â†’</button>
                                    )}
                                </div>
                            </div>
                            
                            {/* Validation Status */}
                            <div className={`flex items-center gap-3 p-3 rounded-lg ${shifts.length > 0 && Object.keys(payrollReport).length > 0 ? (Math.abs(diffTotal) < PAY_TOLERANCE ? 'bg-emerald-100 border border-emerald-300' : 'bg-red-100 border border-red-300') : 'bg-slate-100 border border-slate-300'}`}>
                                {shifts.length > 0 && Object.keys(payrollReport).length > 0 ? (
                                    Math.abs(diffTotal) < PAY_TOLERANCE ? (
                                        <Icons.CheckCircle className="w-5 h-5 text-emerald-600 flex-shrink-0"/>
                                    ) : (
                                        <Icons.AlertTriangle className="w-5 h-5 text-red-600 flex-shrink-0"/>
                                    )
                                ) : (
                                    <Icons.Clock className="w-5 h-5 text-slate-400 flex-shrink-0"/>
                                )}
                                <div className="flex-1 min-w-0">
                                    <div className={`font-bold text-sm ${shifts.length > 0 && Object.keys(payrollReport).length > 0 ? (Math.abs(diffTotal) < PAY_TOLERANCE ? 'text-emerald-800' : 'text-red-800') : 'text-slate-600'}`}>
                                        {shifts.length > 0 && Object.keys(payrollReport).length > 0 ? (
                                            Math.abs(diffTotal) < PAY_TOLERANCE ? 'Validated âœ“' : `Discrepancy: ${formatMoney(Math.abs(diffTotal))}`
                                        ) : (
                                            'Pending Imports'
                                        )}
                                    </div>
                                    {shifts.length === 0 || Object.keys(payrollReport).length === 0 ? (
                                        <div className="text-xs text-slate-500">Complete imports first</div>
                                    ) : null}
                                </div>
                            </div>
                        </div>
                    </div>
                
                     {showGuide && (
                        <div className="bg-white rounded-lg shadow-sm border p-3 flex justify-between items-center text-xs animate-in slide-in-from-top-1 no-print">
                            <div className="flex items-center gap-2">
                                <span className={`h-2 w-2 rounded-full ${shifts.length > 0 ? 'bg-emerald-500' : 'bg-amber-500'}`}></span>
                                <span className="font-bold text-slate-700">{shifts.length === 0 ? "Step 1: Import Timecard" : "Step 2: Review & Validate"}</span>
                            </div>
                            <button onClick={() => setShowGuide(false)}><Icons.X className="w-3 h-3"/></button>
                        </div>
                    )}
                    
                    {/* Pay Period Summary Card */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6 relative overflow-hidden">
                        <div className="flex flex-col md:flex-row justify-between items-center gap-6 z-10 relative">
                            {/* Metric 1: Projected */}
                            <div className="text-center md:text-left">
                                <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Projected Pay</div>
                                <div className="text-3xl font-black text-slate-700">{formatMoney(calculatedData.grandTotalPay)}</div>
                                <div className="text-xs text-slate-400">Based on {shifts.length} shifts</div>
                            </div>

                            {/* Metric 2: Actual (Conditional) */}
                            {actualTotalPay !== null ? (
                                 <div className="text-center md:text-left relative pl-6 md:border-l border-slate-100">
                                    <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Actual Pay</div>
                                    <div className="text-3xl font-black text-teal-600">{formatMoney(actualTotalPay)}</div>
                                    <div className="text-xs text-slate-400">From Payroll Report</div>
                                </div>
                            ) : (
                                <div className="text-center md:text-left relative pl-6 md:border-l border-slate-100 opacity-50">
                                     <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Actual Pay</div>
                                     <div className="text-xl font-bold text-slate-300">--.--</div>
                                     <div className="text-xs text-indigo-400 font-bold cursor-pointer" onClick={() => setActiveTab('import')}>+ Import Report</div>
                                </div>
                            )}

                            {/* Metric 3: Difference (Conditional) */}
                            {actualTotalPay !== null && (
                                <div className="text-center md:text-left relative pl-6 md:border-l border-slate-100">
                                    <div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Discrepancy</div>
                                    <div className={`text-3xl font-black ${Math.abs(diffTotal) < 1 ? 'text-emerald-500' : diffTotal < 0 ? 'text-red-500' : 'text-emerald-600'}`}>
                                        {diffTotal > 0 ? '+' : ''}{formatMoney(diffTotal)}
                                    </div>
                                    <div className={`text-xs font-bold ${Math.abs(diffTotal) < 1 ? 'text-emerald-600' : diffTotal < 0 ? 'text-red-600' : 'text-emerald-600'}`}>
                                        {Math.abs(diffTotal) < 1 ? 'Perfect Match' : diffTotal < 0 ? 'Underpaid' : 'Surplus'}
                                    </div>
                                </div>
                            )}

                            {/* AI, PDF & Settings Buttons */}
                             <div className="flex items-center gap-3 ml-auto no-print">
                                <button 
                                    onClick={() => window.print()}
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-800 text-white text-xs font-bold rounded-full flex items-center gap-2 transition-all shadow-md"
                                    title="Export to PDF"
                                >
                                    <Icons.FileText className="w-4 h-4" /> Export PDF
                                </button>
                                
                                <button 
                                    onClick={() => onOpenAI(calculatedData)}
                                    className="ai-glow px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded-full flex items-center gap-2 transition-all shadow-lg shadow-indigo-200"
                                >
                                    <Icons.Sparkles className="w-4 h-4" /> Analyze
                                </button>
                                
                                <div className="flex items-center gap-3">
                                    {/* Base Wage Input - Prominent & Clear */}
                                    <div className="flex items-center gap-2 bg-gradient-to-br from-emerald-50 to-teal-50 px-3 py-2 rounded-lg border-2 border-emerald-200 hover:border-emerald-300 transition-all shadow-sm group">
                                        <div className="flex flex-col">
                                            <label className="text-[10px] uppercase font-bold text-emerald-700 tracking-wide">My Base Rate</label>
                                            <div className="flex items-baseline gap-1.5">
                                                <span className="text-emerald-600 font-bold text-lg">$</span>
                                                <input 
                                                    type="number" 
                                                    step="0.01"
                                                    min="0"
                                                    value={settings.baseRate} 
                                                    onChange={(e) => setSettings({...settings, baseRate: parseFloat(e.target.value) || 0})} 
                                                    className="w-20 bg-transparent font-bold text-slate-800 text-lg outline-none border-b-2 border-transparent focus:border-emerald-500 transition-colors pr-1"
                                                    placeholder="40.00"
                                                />
                                                <span className="text-slate-500 text-sm">/hr</span>
                                        </div>
                                    </div>
                                        <div className="text-emerald-400 group-hover:text-emerald-500 transition-colors" title="This is your base hourly rate. All calculations start here.">
                                            <Icons.DollarSign className="w-4 h-4" />
                                        </div>
                                    </div>
                                    
                                    {/* Settings Button */}
                                    <button 
                                        onClick={() => setIsSettingsOpen(!isSettingsOpen)} 
                                        className="p-2.5 hover:bg-slate-100 rounded-lg transition-colors text-slate-400 hover:text-teal-500 border border-slate-200"
                                        title="Advanced Settings"
                                    >
                                        <Icons.Settings className="w-4 h-4" />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Settings Panel */}
                        {isSettingsOpen && (
                            <div className="mt-4 pt-4 border-t border-slate-100 grid gap-4 md:grid-cols-2 text-xs animate-in slide-in-from-top-1">
                                 <div><label className="font-bold text-slate-500 block mb-1">Pay Period Start</label><input type="date" value={settings.payPeriodAnchor} onChange={(e) => setSettings({...settings, payPeriodAnchor: e.target.value})} className="w-full p-2 border rounded"/></div>
                                 <div className="col-span-2 pt-2 border-t mt-2"><button onClick={handleClearData} className="w-full py-2 bg-red-50 text-red-600 border border-red-200 rounded font-bold hover:bg-red-100 flex items-center justify-center gap-2">Clear All Data</button></div>
                            </div>
                        )}
                    </div>

                    {groupedData.map(g => (
                        <div key={g.startDate} className="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                            {/* Pay Period Header */}
                            <div className="bg-gradient-to-r from-slate-800 to-slate-700 px-6 py-4 flex justify-between items-center">
                                <div className="flex items-center gap-4">
                                    <button 
                                        onClick={() => removePayPeriod(g.startDate, g.endDate)} 
                                        className="text-slate-400 hover:text-red-400 transition-colors p-1"
                                    >
                                        <Icons.Trash2 className="w-4 h-4" />
                                    </button>
                                    <span className="text-white font-bold">
                                        {new Date(g.startDate+432e5).toLocaleDateString()} - {new Date(g.endDate+432e5).toLocaleDateString()}
                                    </span>
                                </div>
                                <span className="text-white font-bold text-lg">{formatMoney(g.totalPay)}</span>
                            </div>

                            {/* Table Header - Desktop Only */}
                            <div className="hidden md:grid grid-cols-12 gap-3 px-6 py-3 bg-slate-50 border-b border-slate-200 text-[10px] font-bold text-slate-500 uppercase tracking-wider">
                                <div className="col-span-2">Date</div>
                                <div className="col-span-2 text-center">My Hours</div>
                                <div className="col-span-2 text-center">PAR Hours</div>
                                <div className="col-span-2 text-right">My Calc</div>
                                <div className="col-span-2 text-right">Actual</div>
                                <div className="col-span-2 text-right">Status</div>
                            </div>

                            {/* Table Rows */}
                            <div>
                                {Object.values(g.weeks).sort((a,b)=>a.startDate-b.startDate).map(w => (
                                    <React.Fragment key={w.startDate}>
                                        {Object.values(w.days).sort((a,b)=>a.date.localeCompare(b.date)).map(dayGroup => (
                                            <DailyRow 
                                                key={dayGroup.date} 
                                                dayGroup={dayGroup} 
                                                settings={settings} 
                                                onUpdate={updateShift} 
                                                onRemove={removeDay} 
                                                onAddShift={addShift} 
                                                reportData={payrollReport[dayGroup.date]} 
                                                dailyCalc={dailyTotals[dayGroup.date]} 
                                                isExpanded={expandedCards[dayGroup.date]} 
                                                onToggleExpand={() => setExpandedCards(p => ({...p, [dayGroup.date]: !p[dayGroup.date]}))} 
                                                setActiveTab={setActiveTab} 
                                            />
                                        ))}
                                    </React.Fragment>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸš€ MAIN APP ORCHESTRATOR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Main application component - orchestrates all views and state management
         * Handles localStorage persistence, tab navigation, and data imports
         * @component
         */
        function PayslipAuditor() {
            const [activeTab, setActiveTab] = useState('import'); 
            // SAFE STORAGE: prevents crash if localstorage has garbage
            const [shifts, setShifts] = useState(() => {
                try { return JSON.parse(localStorage.getItem('shifts')) || [] } catch { return [] }
            });
            const [payrollReport, setPayrollReport] = useState(() => {
                try { return JSON.parse(localStorage.getItem('payrollReport')) || {} } catch { return {} }
            });
            const [detectedCodes, setDetectedCodes] = useState(() => {
                try { return JSON.parse(localStorage.getItem('detectedCodes')) || [] } catch { return [] }
            });
            const [importMode, setImportMode] = useState('timecard');
            const [importText, setImportText] = useState('');
            const [settings, setSettings] = useState(() => { 
                try { 
                    return JSON.parse(localStorage.getItem('settings')) || DEFAULT_SETTINGS;
                } catch { 
                    return DEFAULT_SETTINGS;
                } 
            });
            
            const [showAI, setShowAI] = useState(false);
            const [aiCalculatedData, setAiCalculatedData] = useState(null);
            
            // Welcome Modal for first-time users
            const [showWelcome, setShowWelcome] = useState(() => {
                return !localStorage.getItem('hasVisited');
            });

            useEffect(() => { localStorage.setItem('shifts', JSON.stringify(shifts)); }, [shifts]);
            useEffect(() => { localStorage.setItem('payrollReport', JSON.stringify(payrollReport)); }, [payrollReport]);
            useEffect(() => { localStorage.setItem('detectedCodes', JSON.stringify(detectedCodes)); }, [detectedCodes]);
            useEffect(() => { localStorage.setItem('settings', JSON.stringify(settings)); }, [settings]);
            
            const handleImport = () => {
                try {
                    if (importMode === 'timecard') {
                        const res = parseTimecardHelper(importText);
                        if(res.success) {
                            setShifts(prev => { const newS = res.shifts.filter(n => !prev.some(p => p.date === n.date && p.startTime === n.startTime)); return [...prev, ...newS]; });
                            if(res.minDate) {
                                 const minD = new Date(res.minDate + 'T12:00:00'); 
                                 const dDiff = minD.getDate() - minD.getDay(); 
                                 const anchor = new Date(minD); anchor.setDate(dDiff);
                                 setSettings(p => ({...p, payPeriodAnchor: anchor.toISOString().split('T')[0]}));
                            }
                            setImportText(''); setActiveTab('calculator'); alert(`âœ… Imported ${res.shifts.length} shifts.`);
                        } else {
                            alert('âŒ No dates found in the pasted text.\n\nTip: Make sure you copied from Kronos in LIST VIEW, not Grid View.');
                        }
                     } else {
                         const res = parsePayrollReportHelper(importText, payrollReport);
                        if(res.success) { 
                            setPayrollReport(res.data); 
                            const newCodes = Object.values(res.data).flatMap(d => d.entries.map(e => e.code));
                            setDetectedCodes([...new Set([...detectedCodes, ...newCodes])]); 
                            setImportText(''); 
                            setActiveTab('calculator'); 
                            
                            // Show what was imported
                            const uniqueCodes = [...new Set(newCodes)];
                            alert(`âœ… Imported ${res.count} payroll entries!\n\nğŸ“‹ Pay codes found:\n${uniqueCodes.join('\n')}\n\nDates: ${res.dates.length} days`);
                        } else {
                            alert('âŒ No payroll report entries found.\n\nTip: Make sure you selected "All" items per page and copied the full page text.');
                        }
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert(`âŒ Import failed: ${error.message}\n\nPlease check the browser console for details.`);
                }
            };
            
            const handleCopyAnonymized = () => { navigator.clipboard.writeText(JSON.stringify({shifts, codes: detectedCodes})); alert("Copied!"); };

            // Pay Rate Analysis
            const payRateAnalysis = useMemo(() => {
                const analysis = {};
                Object.values(payrollReport).forEach(day => {
                    day.entries.forEach(entry => {
                        if (!analysis[entry.code]) analysis[entry.code] = { rates: new Set(), totalHours: 0, totalPay: 0 };
                        analysis[entry.code].rates.add(entry.rate);
                        analysis[entry.code].totalHours += entry.hours;
                        analysis[entry.code].totalPay += entry.amount;
                    });
                });
                return analysis;
            }, [payrollReport]);
            
            // Calculate totals for Report page (using SAME logic as Dashboard)
            const calculatedTotals = useMemo(() => {
                const sorted = [...shifts].sort((a, b) => new Date(`${a.date}T${a.startTime}`) - new Date(`${b.date}T${b.startTime}`));
                let grandTotalPay = 0;
                let totalHours = 0;
                const getWeekStart = (d) => {
                    const date = new Date(d);
                    const diff = date.getDate() - date.getDay() + (date.getDay() < settings.workWeekStartDay ? -7 : 0);
                    date.setDate(diff); date.setHours(0,0,0,0); return date.getTime();
                };
                let weeklyAccumulator = 0;
                let currentWeekStart = null;
                
                sorted.forEach(shift => {
                    const s = new Date(`${shift.date}T${shift.startTime}`);
                    const ws = getWeekStart(s);
                    if (currentWeekStart !== ws) { weeklyAccumulator = 0; currentWeekStart = ws; }
                    
                    const hrs = parseFloat(shift.totalHours) || 0;
                    totalHours += hrs;
                    let rate = parseFloat(shift.payRate) || settings.baseRate;
                    let computedHours = hrs;
                    
                    if (shift.mando || shift.holdover) computedHours = hrs * 2;
                    
                    const normalHours = Math.min(computedHours, Math.max(0, settings.otThreshold - weeklyAccumulator));
                    const otHours = Math.max(0, computedHours - normalHours);
                    const basePay = normalHours * rate;
                    const otPay = otHours * rate * 1.5;
                    grandTotalPay += basePay + otPay;
                    
                    weeklyAccumulator += computedHours;
                    
                    // Bonuses
                    if (shift.missedMeal) grandTotalPay += settings.mealBonusHours * rate;
                    if (shift.sick) grandTotalPay += hrs * rate;
                });
                
                return { grandTotalPay, totalHours };
            }, [shifts, settings]);
            
            const handleOpenAI = (calcData) => {
                setAiCalculatedData(calcData);
                setShowAI(true);
            };

            return (
                <ErrorBoundary>
                    {/* Welcome Modal for First-Time Users */}
                    {showWelcome && <WelcomeModal onClose={() => setShowWelcome(false)} />}
                    
                    <div className="max-w-6xl mx-auto space-y-6 pb-safe">
                        <div className="bg-slate-900 text-white p-4 sticky top-0 z-20 shadow-lg">
                            <div className="flex justify-between items-center">
                                 {/* Brand Logo & Title */}
                                 <div className="flex items-center gap-3">
                                     <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                         <path d="M16 2L6 6V14C6 20.5 10 26.5 16 29C22 26.5 26 20.5 26 14V6L16 2Z" fill="#14B8A6"/>
                                         <path d="M11 16L14 19L21 11" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                                     </svg>
                                     <div className="hidden sm:block">
                                         <h1 className="font-bold text-base leading-tight">CoCo ShadowLedger</h1>
                                          <p className="text-xs text-teal-400">v8.10 (Current)</p>
                                 </div>
                                     <h1 className="sm:hidden font-bold">CoCo SL</h1>
                            </div>
                                 {/* Tab Navigation */}
                                 <div className="flex bg-slate-800 rounded-lg p-1 gap-1">
                                    <button onClick={() => setActiveTab('import')} className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${activeTab==='import'?'bg-teal-500 text-white shadow-sm':'text-slate-400 hover:text-slate-200'}`}>Import</button>
                                    <button onClick={() => setActiveTab('calculator')} className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${activeTab==='calculator'?'bg-teal-500 text-white shadow-sm':'text-slate-400 hover:text-slate-200'}`}>
                                        <span className="hidden md:inline">Dashboard</span>
                                        <span className="md:hidden">Dash</span>
                                    </button>
                                    <button onClick={() => setActiveTab('report')} className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${activeTab==='report'?'bg-teal-500 text-white shadow-sm':'text-slate-400 hover:text-slate-200'}`}>Report</button>
                                    <button onClick={() => setActiveTab('notes')} className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${activeTab==='notes'?'bg-teal-500 text-white shadow-sm':'text-slate-400 hover:text-slate-200'}`}>
                                        <span className="hidden md:inline">Release Notes</span>
                                        <span className="md:hidden">Notes</span>
                                    </button>
                                    <button onClick={() => setActiveTab('feedback')} className={`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${activeTab==='feedback'?'bg-teal-500 text-white shadow-sm':'text-slate-400 hover:text-slate-200'}`}>Help</button>
                                 </div>
                            </div>
                            <div className="text-xs text-slate-400 mt-2">ğŸ›¡ï¸ Protect your paycheck - Audit your EMS shifts in seconds</div>
                        </div>

                        <div className="p-4">
                            {activeTab === 'import' && <ImportView importMode={importMode} setImportMode={setImportMode} importText={importText} setImportText={setImportText} handleImport={handleImport} settings={settings} setSettings={setSettings} />}
                            {activeTab === 'report' && <ReportView payrollReport={payrollReport} payRateAnalysis={payRateAnalysis} calculatedTotals={calculatedTotals} />}
                            {activeTab === 'notes' && <ReleaseNotesView />}
                            {activeTab === 'feedback' && <HelpView detectedCodes={detectedCodes} handleCopyAnonymized={handleCopyAnonymized} />}
                            {activeTab === 'calculator' && 
                                <DashboardView 
                                    shifts={shifts} 
                                    payrollReport={payrollReport} 
                                    settings={settings} 
                                    setSettings={setSettings} 
                                    setShifts={setShifts} 
                                    updateShift={(id, f, v) => setShifts(shifts.map(s => s.id === id ? { ...s, [f]: v } : s))}
                                    removeShift={(id) => setShifts(shifts.filter(s => s.id !== id))}
                                    addShift={(d) => setShifts([...shifts, { id: generateId(), date: d, startTime: '17:00', endTime: '05:00', isHoliday: false, claimFreeHour: false, isHoldover: false, isMando: false, isPaidLeave: false, paidLeaveHours: 12 }])}
                                    removePayPeriod={(s, e) => { if(confirm("Delete pay period?")) setShifts(prev => prev.filter(sh => { const t = new Date(sh.date+'T12:00:00').getTime(); return t < s || t > e; })); }}
                                    handleClearData={() => { if(confirm("Clear ALL data?")) { setShifts([]); setPayrollReport({}); localStorage.clear(); } }}
                                    removeDay={(id, dateStr) => { if (id) setShifts(shifts.filter(s => s.id !== id)); else if (dateStr && confirm(`Delete ${dateStr}?`)) setShifts(prev => prev.filter(s => s.date !== dateStr)); }}
                                    setActiveTab={setActiveTab}
                                    onOpenAI={handleOpenAI}
                                />
                            }
                        </div>
                        
                        {showAI && <AiAssistant shifts={shifts} report={payrollReport} calculated={aiCalculatedData} onClose={() => setShowAI(false)} />}
                    </div>
                </ErrorBoundary>
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¬ APP INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Mount React app to DOM
        const root = createRoot(document.getElementById('root'));
        root.render(<PayslipAuditor />);
    </script>
</body>
</html>